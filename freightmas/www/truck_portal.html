{% extends "templates/web.html" %}

{% block title %}{{ doc.name }} - Truck Portal{% endblock %}

{% block page_content %}
<style>
  html {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) fixed;
    background-attachment: fixed;
    min-height: 100%;
  }
  
  body {
    background: transparent;
    min-height: 100vh;
  }
  
  /* Hide any default navigation elements and footer */
  .page-header-actions-block,
  .page-head-content,
  .standard-sidebar,
  nav.navbar,
  footer,
  .web-footer,
  .footer-powered,
  .page-footer {
    display: none !important;
  }
  
  /* Force container positioning - Remove all top spacing */
  .container-fluid {
    margin-top: 0 !important;
    padding-top: 0 !important;
  }
  
  /* Back to Desk Link */
  .back-to-desk {
    position: fixed;
    top: 15px;
    right: 15px;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 13px;
    font-weight: 600;
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  
  .back-to-desk:hover {
    background: rgba(255, 255, 255, 0.35);
    color: white;
    text-decoration: none;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  /* Glass Container */
  .glass-container {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    border: none;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    padding: 25px;
    margin-bottom: 15px;
  }
  
  /* Page Header - Compressed */
  .page-header {
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(15px);
    color: white !important;
    padding: 15px 20px;
    border-radius: 12px;
    margin-bottom: 12px;
    margin-top: 15px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  }
  
  .page-header h1 {
    margin: 0 0 10px 0;
    font-size: 22px;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    color: white !important;
  }
  
  .page-header .meta {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
  }
  
  .meta-item {
    font-size: 14px;
    display: flex;
    gap: 6px;
    align-items: baseline;
    color: white;
  }
  
  .meta-item .label {
    opacity: 0.85;
    font-size: 12px;
  }
  
  .meta-item .value {
    font-weight: 600;
    font-size: 14px;
  }
  
  /* Search Toolbar */
  .toolbar {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    padding: 12px 15px;
    border-radius: 12px;
    margin-bottom: 12px;
    border: 1px solid rgba(255, 255, 255, 0.25);
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .search-box {
    flex: 1;
    min-width: 250px;
  }
  
  .search-box input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.9);
    font-size: 13px;
  }
  
  .search-box input:focus {
    outline: none;
    background: white;
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
  }
  
  .filter-select {
    padding: 8px 12px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.9);
    font-size: 13px;
    cursor: pointer;
  }
  
  .btn-clear {
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.4);
    color: white;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 13px;
  }
  
  .btn-clear:hover {
    background: rgba(255, 255, 255, 0.4);
  }
  
  /* Cargo Table */
  .cargo-table {
    background: transparent;
    backdrop-filter: none;
    border-radius: 15px;
    overflow: visible;
    border: none;
  }
  
  .cargo-row {
    background: rgba(255, 255, 255, 0.95);
    margin-bottom: 10px;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s;
    position: relative;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  .cargo-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    background: rgba(255, 255, 255, 1);
  }
  
  /* Row Header */
  .row-header {
    display: grid;
    grid-template-columns: 2fr 2fr 1.2fr 2fr 1.3fr 180px;
    gap: 15px;
    padding: 12px 20px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    margin-bottom: 10px;
    font-size: 13px;
    align-items: center;
  }
  
  .row-header .col {
    font-weight: 700;
    color: #1e293b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 12px;
  }
  
  /* Data Row */
  .data-row {
    display: grid;
    grid-template-columns: 2fr 2fr 1.2fr 2fr 1.3fr 180px;
    gap: 15px;
    padding: 15px 20px;
    font-size: 13px;
    align-items: center;
  }
  
  .data-row .col {
    color: #334155;
  }
  
  .col-container {
    font-weight: 600;
    color: #1e293b;
  }
  
  .col-type {
    font-size: 11px;
    color: #64748b;
    margin-top: 2px;
  }
  
  /* Actions Column */
  .actions-column {
    display: flex;
    align-items: center;
    gap: 6px;
    justify-content: flex-end;
  }
  
  /* Action Buttons */
  .btn-action {
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: white;
    color: #2e3338;
    border: 1px solid #d1d5db;
  }
  
  .btn-action:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .btn-action:active {
    transform: translateY(0);
  }
  
  .add-booking-btn,
  .update-tracking-btn {
    border-color: #9ca3af;
  }
  
  .add-booking-btn:hover,
  .update-tracking-btn:hover {
    border-color: #6b7280;
  }
  
  /* Details Button icon rotation */
  .btn-details i {
    transition: transform 0.3s;
  }
  
  .cargo-row.expanded .btn-details i {
    transform: rotate(180deg);
  }
  
  /* Status Badge */
  .status-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-block;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
  }
  
  .status-pending { background: #fef3c7; color: #92400e; }
  .status-pending-approval { background: #fef3c7; color: #92400e; }
  .status-approved { background: #d1fae5; color: #065f46; }
  .status-booked { background: #dbeafe; color: #1e40af; }
  .status-in-transit { background: #fed7aa; color: #9a3412; }
  .status-delivered { background: #e0e7ff; color: #3730a3; }
  .status-draft { background: #fee2e2; color: #991b1b; }
  .status-loading { background: #fbcfe8; color: #831843; }
  .status-rejected { background: #fecaca; color: #991b1b; }
  
  /* Detail Panel - ACCORDION STYLE */
  .detail-panel {
    display: none;
    background: #f8f9fb;
    padding: 0;
    border-top: 2px solid #e5e7eb;
  }
  
  .detail-panel.show {
    display: block;
  }
  
  /* Accordion Section */
  .accordion-section {
    border-bottom: 1px solid #e5e7eb;
  }
  
  .accordion-section:last-child {
    border-bottom: none;
  }
  
  .accordion-header {
    padding: 15px 20px;
    background: white;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
    user-select: none;
  }
  
  .accordion-header:hover {
    background: #f9fafb;
  }
  
  .accordion-header.active {
    background: #f3f4f6;
  }
  
  .accordion-title {
    font-size: 14px;
    font-weight: 700;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .accordion-icon {
    transition: transform 0.3s;
    color: #64748b;
  }
  
  .accordion-header.active .accordion-icon {
    transform: rotate(90deg);
  }
  
  .accordion-content {
    display: none;
    padding: 20px;
    background: #fafbfc;
  }
  
  .accordion-content.show {
    display: block;
  }
  
  /* Info Grid */
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
  }
  
  .info-item {
    background: white;
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }
  
  .info-label {
    font-size: 11px;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 4px;
    display: block;
  }
  
  .info-value {
    font-size: 14px;
    color: #1e293b;
    font-weight: 500;
  }
  
  .info-value.empty {
    color: #9ca3af;
    font-style: italic;
  }
  
  /* Approval Section Styles */
  .approval-banner {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid #fbbf24;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
  }
  
  .approval-banner.approved {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    border-color: #10b981;
  }
  
  .approval-banner.rejected {
    background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
    border-color: #ef4444;
  }
  
  .approval-banner-title {
    font-size: 16px;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .approval-banner-text {
    font-size: 13px;
    color: #475569;
    margin-bottom: 15px;
  }
  
  .approval-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .btn-approve {
    background: #10b981;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  
  .btn-approve:hover {
    background: #059669;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }
  
  .btn-reject {
    background: #ef4444;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  
  .btn-reject:hover {
    background: #dc2626;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }
  
  .approval-history {
    background: white;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e5e7eb;
  }
  
  .approval-history-title {
    font-size: 12px;
    font-weight: 700;
    color: #64748b;
    text-transform: uppercase;
    margin-bottom: 10px;
  }
  
  .approval-history-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f1f5f9;
  }
  
  .approval-history-item:last-child {
    border-bottom: none;
  }
  
  /* Alert Message */
  .no-truck-alert {
    color: #dc2626;
    font-size: 12px;
    font-weight: 600;
  }
  
  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: white;
  }
  
  .empty-state i {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.5;
  }
  
  /* Modal Styling */
  .modal-content {
    border-radius: 20px;
    border: none;
    overflow: hidden;
  }
  
  .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 20px 30px;
  }
  
  .modal-body {
    padding: 30px;
  }
  
  .modal-footer {
    background: #f8f9fb;
    border: none;
    padding: 20px 30px;
  }
  
  .form-control {
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px 15px;
  }
  
  .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .btn-success {
    background: #10b981;
    border: none;
    padding: 10px 25px;
    border-radius: 10px;
    font-weight: 600;
  }
  
  .btn-secondary {
    background: #64748b;
    border: none;
    padding: 10px 25px;
    border-radius: 10px;
    font-weight: 600;
  }
  
  /* Responsive */
  @media (max-width: 1200px) {
    .row-header {
      display: none;
    }
    
    .data-row {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    
    .data-row .col::before {
      content: attr(data-label);
      font-weight: 600;
      display: inline-block;
      width: 120px;
      color: #64748b;
    }
    
    .info-grid {
      grid-template-columns: 1fr;
    }
    
    .page-header .meta {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
  }
  
  @media (max-width: 768px) {
    .page-header {
      margin-top: 10px;
    }
    
    .page-header h1 {
      font-size: 18px;
    }
    
    .glass-container {
      padding: 20px;
    }
    
    .back-to-desk {
      position: static;
      display: block;
      margin-bottom: 15px;
      text-align: center;
    }
  }
</style>

<!-- Back to Desk Link -->
<a href="/app" class="back-to-desk">
  <i class="fa fa-arrow-left"></i> Back to Desk
</a>

<div class="container-fluid" style="max-width: 1600px; margin: 0 auto; padding: 8px 15px;">
  
  <!-- Page Header -->
  <div class="page-header">
    <h1><i class="fa fa-ship"></i> {{ doc.name }}</h1>
    <div class="meta">
      <div class="meta-item">
        <span class="label">Customer:</span>
        <span class="value">{{ doc.customer }}</span>
      </div>
      <div class="meta-item">
        <span class="label">Direction:</span>
        <span class="value">{{ doc.direction }}</span>
      </div>
      <div class="meta-item">
        <span class="label">Cargo:</span>
        <span class="value">{{ doc.cargo_description or doc.cargo_count }}</span>
      </div>
      <div class="meta-item">
        <span class="label">Trucks:</span>
        <span class="value">{{ doc.trucks_required or '0' }}</span>
      </div>
      <div class="meta-item">
        <span class="label">Date:</span>
        <span class="value">{{ frappe.format_date(doc.creation) }}</span>
      </div>
    </div>
  </div>

  <!-- Search Toolbar -->
  <div class="toolbar">
    <div class="search-box">
      <input type="text" id="search-input" placeholder="Search by container, truck, driver or transporter...">
    </div>
    <select class="filter-select" id="status-filter">
      <option value="">All Statuses</option>
      <option value="Draft">Draft</option>
      <option value="Pending Approval">Pending Approval</option>
      <option value="Approved">Approved</option>
      <option value="Rejected">Rejected</option>
      <option value="Booked">Booked</option>
      <option value="Loading">Loading</option>
      <option value="In Transit">In Transit</option>
      <option value="Delivered">Delivered</option>
    </select>
    <button class="btn-clear" onclick="clearFilters()">
      <i class="fa fa-redo"></i> Clear
    </button>
  </div>

  <!-- Cargo Table -->
  <div class="glass-container">
    {% if doc.cargo_parcel_details %}
      <div class="cargo-table">
        <!-- Table Header -->
        <div class="row-header">
          <div class="col">Cargo</div>
          <div class="col">Transporter</div>
          <div class="col">Truck Reg</div>
          <div class="col">Driver Name</div>
          <div class="col">Status</div>
          <div class="col" style="text-align: right;">Actions</div>
        </div>

        <!-- Data Rows -->
        {% for cargo in doc.cargo_parcel_details %}
        <div class="cargo-row" 
             data-container="{{ cargo.container_number or cargo.cargo_item_description or '' }}"
             data-truck="{{ cargo.truck_reg_no or '' }}"
             data-driver="{{ cargo.driver_name or '' }}"
             data-transporter="{{ cargo.transporter or '' }}"
             data-status="{{ cargo.booking_status or 'Draft' }}">
          
          <div class="data-row">
            <!-- Cargo -->
            <div class="col col-container" data-label="Cargo: ">
              {% if cargo.cargo_type == 'Containerised' %}
                {{ cargo.container_number or '-' }}
                <div class="col-type">{{ cargo.container_type or '-' }}</div>
              {% else %}
                {{ cargo.cargo_quantity or '1' }} x {{ cargo.cargo_item_description or 'Break Bulk' }}
                <div class="col-type">{{ cargo.container_type or 'Break Bulk' }}</div>
              {% endif %}
            </div>

            <!-- Transporter -->
            <div class="col" data-label="Transporter: ">
              {% if cargo.transporter %}
                {{ cargo.transporter }}
              {% else %}
                <span class="no-truck-alert">
                  {% if cargo.is_truck_required %}
                    Truck Required
                  {% else %}
                    -
                  {% endif %}
                </span>
              {% endif %}
            </div>

            <!-- Truck Registration -->
            <div class="col" data-label="Truck Reg: ">
              {{ cargo.truck_reg_no or '-' }}
            </div>

            <!-- Driver Name -->
            <div class="col" data-label="Driver: ">
              {{ cargo.driver_name or '-' }}
            </div>

            <!-- Status -->
            <div class="col" data-label="Status: ">
              {% if cargo.is_truck_required %}
                <span class="status-badge status-{{ (cargo.booking_status or 'draft')|lower|replace(' ', '-') }}">
                  {{ cargo.booking_status or 'Draft' }}
                </span>
              {% else %}
                <span class="status-badge" style="background: #e2e8f0; color: #64748b;">
                  N/A
                </span>
              {% endif %}
            </div>

            <!-- Actions -->
            <div class="col actions-column" data-label="Actions: ">
              {% if cargo.is_truck_required %}
                {% if not cargo.transporter %}
                  <button class="btn-action add-booking-btn" 
                          data-cargo-idx="{{ loop.index0 }}">
                    <i class="fa fa-plus"></i> Add
                  </button>
                {% elif cargo.booking_status in ['Approved', 'Booked', 'Loading', 'In Transit'] %}
                  <button class="btn-action update-tracking-btn" 
                          data-cargo-idx="{{ loop.index0 }}">
                    <i class="fa fa-route"></i> Update
                  </button>
                {% endif %}
              {% endif %}
              <button class="btn-action btn-details toggle-details-btn">
                <i class="fa fa-chevron-down"></i> Details
              </button>
            </div>
          </div>

          <!-- Detail Panel - ACCORDION STYLE -->
          <div class="detail-panel">
            
            <!-- Cargo Information Section -->
            <div class="accordion-section">
              <div class="accordion-header" data-target="cargo-{{ loop.index0 }}">
                <div class="accordion-title">
                  <i class="fa fa-chevron-right accordion-icon"></i>
                  📦 Cargo Information
                </div>
              </div>
              <div class="accordion-content" id="cargo-{{ loop.index0 }}">
                <div class="info-grid">
                  <div class="info-item">
                    <span class="info-label">Cargo Type</span>
                    <span class="info-value">{{ cargo.cargo_type or '-' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Container/Item</span>
                    <span class="info-value">
                      {% if cargo.cargo_type == 'Containerised' %}
                        {{ cargo.container_number or '-' }}
                      {% else %}
                        {{ cargo.cargo_item_description or '-' }}
                      {% endif %}
                    </span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Container Type</span>
                    <span class="info-value">{{ cargo.container_type or '-' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Weight (kg)</span>
                    <span class="info-value">{{ cargo.weight or '-' }}</span>
                  </div>
                  {% if cargo.cargo_type != 'Containerised' %}
                  <div class="info-item">
                    <span class="info-label">Quantity</span>
                    <span class="info-value">{{ cargo.cargo_quantity or '-' }} {{ cargo.cargo_uom or '' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Volume (CBM)</span>
                    <span class="info-value">{{ cargo.volume or '-' }}</span>
                  </div>
                  {% endif %}
                  <div class="info-item">
                    <span class="info-label">Drop Off Location</span>
                    <span class="info-value">{{ cargo.drop_off_place or '-' }}</span>
                  </div>
                </div>
              </div>
            </div>

            {% if cargo.is_truck_required %}
            <!-- Truck Assignment Section -->
            <div class="accordion-section">
              <div class="accordion-header" data-target="truck-{{ loop.index0 }}">
                <div class="accordion-title">
                  <i class="fa fa-chevron-right accordion-icon"></i>
                  🚛 Truck Assignment
                </div>
              </div>
              <div class="accordion-content" id="truck-{{ loop.index0 }}">
                <div class="info-grid">
                  <div class="info-item">
                    <span class="info-label">Transporter</span>
                    <span class="info-value">{{ cargo.transporter or '-' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Truck Registration</span>
                    <span class="info-value">{{ cargo.truck_reg_no or '-' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Trailer Registration</span>
                    <span class="info-value">{{ cargo.trailer_reg_no or '-' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Driver Name</span>
                    <span class="info-value">{{ cargo.driver_name or '-' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Contact 1</span>
                    <span class="info-value">{{ cargo.driver_contact_no or '-' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Contact 2</span>
                    <span class="info-value">{{ cargo.driver_contact_no_2 or '-' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Passport No</span>
                    <span class="info-value">{{ cargo.driver_passport_no or '-' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Licence No</span>
                    <span class="info-value">{{ cargo.driver_licence_no or '-' }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tracking Section -->
            <div class="accordion-section">
              <div class="accordion-header" data-target="tracking-{{ loop.index0 }}">
                <div class="accordion-title">
                  <i class="fa fa-chevron-right accordion-icon"></i>
                  📍 Tracking & Timeline
                </div>
              </div>
              <div class="accordion-content" id="tracking-{{ loop.index0 }}">
                <div class="info-grid">
                  <div class="info-item">
                    <span class="info-label">Current Location</span>
                    <span class="info-value">
                      {% if cargo.truck_location %}
                        <i class="fa fa-map-marker-alt" style="color: #ef4444;"></i>
                        {{ cargo.truck_location }}
                      {% else %}
                        <span class="empty">Not updated</span>
                      {% endif %}
                    </span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Load By Date</span>
                    <span class="info-value">{{ frappe.format_date(cargo.load_by_date) if cargo.load_by_date else '-' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Last Updated</span>
                    <span class="info-value">{{ frappe.format(cargo.updated_on, {'fieldtype': 'Datetime'}) if cargo.updated_on else '-' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Updated By</span>
                    <span class="info-value">{{ cargo.updated_by or '-' }}</span>
                  </div>
                </div>
                {% if cargo.tracking_comment %}
                <div class="info-item" style="margin-top: 15px;">
                  <span class="info-label">Tracking Comment</span>
                  <span class="info-value">{{ cargo.tracking_comment }}</span>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Approval Section -->
            <div class="accordion-section">
              <div class="accordion-header active" data-target="approval-{{ loop.index0 }}">
                <div class="accordion-title">
                  <i class="fa fa-chevron-right accordion-icon"></i>
                  {% if cargo.booking_status == 'Pending Approval' %}
                    ⚠️ Approval Required
                  {% elif cargo.booking_status == 'Approved' %}
                    ✅ Approval Status
                  {% elif cargo.booking_status == 'Rejected' %}
                    ❌ Approval Status
                  {% else %}
                    ✅ Approval Status
                  {% endif %}
                </div>
              </div>
              <div class="accordion-content show" id="approval-{{ loop.index0 }}">
                
                {% if cargo.booking_status == 'Pending Approval' %}
                <!-- Pending Approval Banner -->
                <div class="approval-banner">
                  <div class="approval-banner-title">
                    <i class="fa fa-clock"></i>
                    Awaiting Approval
                  </div>
                  <div class="approval-banner-text">
                    This booking was submitted by <strong>{{ cargo.transporter }}</strong> on {{ frappe.format_date(cargo.submitted_on) if cargo.submitted_on else 'today' }}. Please review the truck details and approve or reject.
                  </div>
                  <div class="approval-actions">
                    <button class="btn-approve approve-booking-btn" 
                            data-cargo-idx="{{ loop.index0 }}">
                      <i class="fa fa-check"></i> Approve Booking
                    </button>
                    <button class="btn-reject reject-booking-btn" 
                            data-cargo-idx="{{ loop.index0 }}">
                      <i class="fa fa-times"></i> Reject Booking
                    </button>
                  </div>
                </div>
                
                {% elif cargo.booking_status == 'Approved' %}
                <!-- Approved Banner -->
                <div class="approval-banner approved">
                  <div class="approval-banner-title">
                    <i class="fa fa-check-circle"></i>
                    Booking Approved
                  </div>
                  <div class="approval-banner-text">
                    This booking was approved by <strong>{{ cargo.approved_by or 'System' }}</strong> on {{ frappe.format(cargo.approved_on, {'fieldtype': 'Datetime'}) if cargo.approved_on else 'today' }}.
                  </div>
                </div>
                
                {% elif cargo.booking_status == 'Rejected' %}
                <!-- Rejected Banner -->
                <div class="approval-banner rejected">
                  <div class="approval-banner-title">
                    <i class="fa fa-times-circle"></i>
                    Booking Rejected
                  </div>
                  <div class="approval-banner-text">
                    This booking was rejected by <strong>{{ cargo.approved_by or 'System' }}</strong> on {{ frappe.format(cargo.approved_on, {'fieldtype': 'Datetime'}) if cargo.approved_on else 'today' }}.
                  </div>
                  {% if cargo.rejection_reason %}
                  <div class="approval-history">
                    <div class="approval-history-title">Rejection Reason</div>
                    <p style="margin: 0; color: #1e293b;">{{ cargo.rejection_reason }}</p>
                  </div>
                  {% endif %}
                </div>
                
                {% else %}
                <!-- Draft or No Approval Needed -->
                <div class="approval-history">
                  <p style="margin: 0; color: #64748b; font-size: 13px;">
                    {% if cargo.transporter %}
                      No approval action required at this time.
                    {% else %}
                      Truck details have not been submitted yet.
                    {% endif %}
                  </p>
                </div>
                {% endif %}
                
              </div>
            </div>
            {% endif %}

          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">
        <i class="fa fa-box-open"></i>
        <h4>No Cargo Details</h4>
        <p>No cargo information available for this forwarding job.</p>
      </div>
    {% endif %}
  </div>

</div>

<!-- Add Booking Modal -->
<div class="modal fade" id="addBookingModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fa fa-truck"></i> Add Truck Booking
        </h5>
        <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 1;">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="booking-cargo-idx">
        
        <div class="form-group">
          <label style="font-weight: 600;">Transporter <span style="color: #ef4444;">*</span></label>
          <input type="text" class="form-control" id="booking-transporter" placeholder="Start typing to search..." required autocomplete="off">
          <div id="transporter-dropdown" class="dropdown-menu" style="width: 100%; max-height: 200px; overflow-y: auto;"></div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label style="font-weight: 600;">Truck Registration <span style="color: #ef4444;">*</span></label>
              <input type="text" class="form-control" id="booking-truck-reg" placeholder="e.g., ABC-123-GP" required style="text-transform: uppercase;">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label style="font-weight: 600;">Trailer Registration</label>
              <input type="text" class="form-control" id="booking-trailer-reg" placeholder="e.g., XYZ-456-GP" style="text-transform: uppercase;">
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label style="font-weight: 600;">Driver Name <span style="color: #ef4444;">*</span></label>
              <input type="text" class="form-control" id="booking-driver-name" placeholder="Full name" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label style="font-weight: 600;">Driver Contact <span style="color: #ef4444;">*</span></label>
              <input type="text" class="form-control" id="booking-driver-contact" placeholder="0771234567" required>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label style="font-weight: 600;">Driver Passport</label>
              <input type="text" class="form-control" id="booking-driver-passport" placeholder="Passport number" style="text-transform: uppercase;">
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label style="font-weight: 600;">Driver Licence</label>
              <input type="text" class="form-control" id="booking-driver-licence" placeholder="Licence number" style="text-transform: uppercase;">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="submit-booking">
          <i class="fa fa-check"></i> Submit for Approval
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Update Tracking Modal -->
<div class="modal fade" id="updateTrackingModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fa fa-route"></i> Update Tracking
        </h5>
        <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 1;">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="tracking-cargo-idx">
        
        <div class="form-group">
          <label style="font-weight: 600;">Status <span style="color: #ef4444;">*</span></label>
          <select class="form-control" id="tracking-status" required>
            <option value="">Select Status...</option>
            <option value="Loading">Loading</option>
            <option value="In Transit">In Transit</option>
            <option value="Delivered">Delivered</option>
          </select>
        </div>
        
        <div class="form-group">
          <label style="font-weight: 600;">Location <span style="color: #ef4444;">*</span></label>
          <input type="text" class="form-control" id="tracking-location" required placeholder="e.g., Durban Port, Beitbridge Border">
        </div>
        
        <div class="form-group">
          <label style="font-weight: 600;">Comment <span style="color: #ef4444;">*</span></label>
          <textarea class="form-control" id="tracking-comment" rows="4" required placeholder="Provide details about the current status..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="submit-tracking">
          <i class="fa fa-save"></i> Update
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Rejection Reason Modal -->
<div class="modal fade" id="rejectionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
        <h5 class="modal-title">
          <i class="fa fa-times-circle"></i> Reject Booking
        </h5>
        <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 1;">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="rejection-cargo-idx">
        
        <div class="form-group">
          <label style="font-weight: 600;">Reason for Rejection <span style="color: #ef4444;">*</span></label>
          <textarea class="form-control" id="rejection-reason" rows="4" required placeholder="Please provide a clear reason for rejecting this booking..."></textarea>
          <small class="text-muted">This will be shared with the transporter.</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn-danger" id="confirm-rejection" style="background: #ef4444; border: none; padding: 10px 25px; border-radius: 10px; font-weight: 600;">
          <i class="fa fa-times"></i> Confirm Rejection
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}
<script>
$(document).ready(function() {
  const doc_name = '{{ doc.name }}';
  let allSuppliers = [];

  // ========================================
  // ACCORDION FUNCTIONALITY
  // ========================================
  $(document).on('click', '.accordion-header', function(e) {
    e.stopPropagation();
    const $header = $(this);
    const targetId = $header.data('target');
    const $content = $('#' + targetId);
    const $section = $header.closest('.accordion-section');
    
    // Close all other accordions in the same detail panel
    $section.siblings('.accordion-section').each(function() {
      $(this).find('.accordion-header').removeClass('active');
      $(this).find('.accordion-content').removeClass('show');
    });
    
    // Toggle current accordion
    $header.toggleClass('active');
    $content.toggleClass('show');
  });

  // ========================================
  // TOGGLE DETAILS - Handler for Details button with auto-collapse
  // ========================================
  $(document).on('click', '.toggle-details-btn', function(e) {
    e.stopPropagation();
    const cargoRow = $(this).closest('.cargo-row');
    const panel = cargoRow.find('.detail-panel');
    const isCurrentlyExpanded = cargoRow.hasClass('expanded');
    
    // First, collapse ALL other cards
    $('.cargo-row.expanded').not(cargoRow).each(function() {
      $(this).find('.detail-panel').removeClass('show');
      $(this).removeClass('expanded');
    });
    
    // Then toggle the clicked card
    if (isCurrentlyExpanded) {
      panel.removeClass('show');
      cargoRow.removeClass('expanded');
    } else {
      panel.addClass('show');
      cargoRow.addClass('expanded');
      
      // Auto-expand approval section if pending
      const pendingApproval = panel.find('.approval-banner').length > 0;
      if (pendingApproval) {
        panel.find('.accordion-header').each(function() {
          const targetId = $(this).data('target');
          if (targetId && targetId.includes('approval')) {
            $(this).addClass('active');
            $('#' + targetId).addClass('show');
          }
        });
      }
    }
  });

  // ========================================
  // SEARCH AND FILTER
  // ========================================
  function filterCargo() {
    const searchText = $('#search-input').val().toLowerCase();
    const statusFilter = $('#status-filter').val();
    
    $('.cargo-row').each(function() {
      const $card = $(this);
      const container = $card.data('container').toLowerCase();
      const truck = $card.data('truck').toLowerCase();
      const driver = $card.data('driver').toLowerCase();
      const transporter = $card.data('transporter').toLowerCase();
      const status = $card.data('status');
      
      const matchesSearch = !searchText || 
                           container.includes(searchText) ||
                           truck.includes(searchText) ||
                           driver.includes(searchText) ||
                           transporter.includes(searchText);
      
      const matchesStatus = !statusFilter || status === statusFilter;
      
      if (matchesSearch && matchesStatus) {
        $card.show();
      } else {
        $card.hide();
      }
    });
  }
  
  $('#search-input').on('keyup', filterCargo);
  $('#status-filter').on('change', filterCargo);
  
  window.clearFilters = function() {
    $('#search-input').val('');
    $('#status-filter').val('');
    filterCargo();
  };

  // ========================================
  // LOAD SUPPLIERS
  // ========================================
  function loadSuppliers() {
    frappe.call({
      method: 'frappe.client.get_list',
      args: {
        doctype: 'Supplier',
        filters: { disabled: 0 },
        fields: ['name', 'supplier_name'],
        limit_page_length: 500,
        order_by: 'supplier_name asc'
      },
      callback: (r) => {
        if (r.message) {
          allSuppliers = r.message;
        }
      }
    });
  }

  $('#booking-transporter').on('focus', function() {
    if (allSuppliers.length === 0) {
      loadSuppliers();
    }
  });

  $('#booking-transporter').on('input', function() {
    const searchTerm = $(this).val().toLowerCase();
    const $dropdown = $('#transporter-dropdown');
    
    if (searchTerm.length < 2) {
      $dropdown.hide();
      return;
    }
    
    const filtered = allSuppliers.filter(s => 
      (s.supplier_name && s.supplier_name.toLowerCase().includes(searchTerm)) ||
      (s.name && s.name.toLowerCase().includes(searchTerm))
    );
    
    if (filtered.length > 0) {
      $dropdown.empty();
      filtered.forEach(supplier => {
        const displayName = supplier.supplier_name || supplier.name;
        $dropdown.append(`
          <a class="dropdown-item" href="#" data-value="${supplier.name}">
            ${displayName}
          </a>
        `);
      });
      $dropdown.show();
    } else {
      $dropdown.hide();
    }
  });

  $(document).on('click', '#transporter-dropdown .dropdown-item', function(e) {
    e.preventDefault();
    const value = $(this).data('value');
    const displayText = $(this).text();
    $('#booking-transporter').val(displayText).data('supplier-id', value);
    $('#transporter-dropdown').hide();
  });

  $(document).on('click', function(e) {
    if (!$(e.target).closest('#booking-transporter, #transporter-dropdown').length) {
      $('#transporter-dropdown').hide();
    }
  });

  // ========================================
  // ADD BOOKING
  // ========================================
  $(document).on('click', '.add-booking-btn', function(e) {
    e.stopPropagation();
    const idx = $(this).data('cargo-idx');
    $('#booking-cargo-idx').val(idx);
    $('#booking-transporter').val('').removeData('supplier-id');
    $('#booking-truck-reg').val('');
    $('#booking-trailer-reg').val('');
    $('#booking-driver-name').val('');
    $('#booking-driver-contact').val('');
    $('#booking-driver-passport').val('');
    $('#booking-driver-licence').val('');
    if (allSuppliers.length === 0) loadSuppliers();
    $('#addBookingModal').modal('show');
  });

  $('#submit-booking').click(function() {
    const idx = $('#booking-cargo-idx').val();
    const transporterId = $('#booking-transporter').data('supplier-id');
    const transporterName = $('#booking-transporter').val();
    
    const data = {
      transporter: transporterId || transporterName,
      truck_reg_no: $('#booking-truck-reg').val().toUpperCase(),
      trailer_reg_no: $('#booking-trailer-reg').val().toUpperCase(),
      driver_name: $('#booking-driver-name').val(),
      driver_contact_no: $('#booking-driver-contact').val(),
      driver_passport_no: $('#booking-driver-passport').val().toUpperCase(),
      driver_licence_no: $('#booking-driver-licence').val().toUpperCase(),
      booking_status: 'Pending Approval',
      submitted_on: frappe.datetime.now_datetime()
    };

    if (!data.transporter || !data.truck_reg_no || !data.driver_name || !data.driver_contact_no) {
      frappe.msgprint('Please fill all required fields');
      return;
    }

    $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Submitting...');

    frappe.call({
      method: 'freightmas.www.truck_portal.add_truck_booking',
      args: { job: doc_name, cargo_idx: idx, ...data },
      callback: (r) => {
        if (r.message && r.message.success) {
          $('#addBookingModal').modal('hide');
          frappe.show_alert({ message: 'Booking submitted for approval!', indicator: 'green' });
          setTimeout(() => location.reload(), 1500);
        }
      },
      error: () => {
        $('#submit-booking').prop('disabled', false).html('<i class="fa fa-check"></i> Submit for Approval');
      }
    });
  });

  // ========================================
  // APPROVE BOOKING
  // ========================================
  $(document).on('click', '.approve-booking-btn', function(e) {
    e.stopPropagation();
    const idx = $(this).data('cargo-idx');
    
    frappe.confirm(
      'Are you sure you want to approve this truck booking?',
      () => {
        $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Approving...');
        
        frappe.call({
          method: 'freightmas.www.truck_portal.approve_booking',
          args: { 
            job: doc_name, 
            cargo_idx: idx
          },
          callback: (r) => {
            if (r.message && r.message.success) {
              frappe.show_alert({ message: 'Booking approved successfully!', indicator: 'green' });
              setTimeout(() => location.reload(), 1500);
            }
          }
        });
      }
    );
  });

  // ========================================
  // REJECT BOOKING
  // ========================================
  $(document).on('click', '.reject-booking-btn', function(e) {
    e.stopPropagation();
    const idx = $(this).data('cargo-idx');
    $('#rejection-cargo-idx').val(idx);
    $('#rejection-reason').val('');
    $('#rejectionModal').modal('show');
  });

  $('#confirm-rejection').click(function() {
    const idx = $('#rejection-cargo-idx').val();
    const reason = $('#rejection-reason').val().trim();
    
    if (!reason) {
      frappe.msgprint('Please provide a reason for rejection');
      return;
    }

    $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Rejecting...');

    frappe.call({
      method: 'freightmas.www.truck_portal.reject_booking',
      args: { 
        job: doc_name, 
        cargo_idx: idx,
        reason: reason
      },
      callback: (r) => {
        if (r.message && r.message.success) {
          $('#rejectionModal').modal('hide');
          frappe.show_alert({ message: 'Booking rejected', indicator: 'orange' });
          setTimeout(() => location.reload(), 1500);
        }
      },
      error: () => {
        $('#confirm-rejection').prop('disabled', false).html('<i class="fa fa-times"></i> Confirm Rejection');
      }
    });
  });

  // ========================================
  // UPDATE TRACKING
  // ========================================
  $(document).on('click', '.update-tracking-btn', function(e) {
    e.stopPropagation();
    const idx = $(this).data('cargo-idx');
    $('#tracking-cargo-idx').val(idx);
    $('#tracking-status').val('');
    $('#tracking-location').val('');
    $('#tracking-comment').val('');
    $('#updateTrackingModal').modal('show');
  });

  $('#submit-tracking').click(function() {
    const idx = $('#tracking-cargo-idx').val();
    const data = {
      status: $('#tracking-status').val(),
      location: $('#tracking-location').val(),
      comment: $('#tracking-comment').val()
    };

    if (!data.status || !data.location || !data.comment) {
      frappe.msgprint('Please fill all fields');
      return;
    }

    $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Updating...');

    frappe.call({
      method: 'freightmas.www.truck_portal.update_tracking',
      args: { job: doc_name, cargo_idx: idx, ...data },
      callback: (r) => {
        if (r.message && r.message.success) {
          $('#updateTrackingModal').modal('hide');
          frappe.show_alert({ message: 'Tracking updated', indicator: 'green' });
          setTimeout(() => location.reload(), 1500);
        }
      },
      error: () => {
        $('#submit-tracking').prop('disabled', false).html('<i class="fa fa-save"></i> Update');
      }
    });
  });
});
</script>
{% endblock %}