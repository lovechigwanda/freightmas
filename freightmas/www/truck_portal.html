{% extends "templates/web.html" %}

{% block title %}{{ doc.name }} - Truck Portal{% endblock %}

{% block page_content %}
<style>
  html, body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
    min-height: 100vh;
    font-weight: 400;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .page-header-actions-block,
  .page-head-content,
  .standard-sidebar,
  nav.navbar,
  footer,
  .web-footer,
  .footer-powered,
  .page-footer {
    display: none !important;
  }

  .container-fluid {
    padding: 0 !important;
    margin: 0 !important;
    max-width: none !important;
  }

  .back-to-desk {
    position: fixed;
    top: 15px;
    right: 15px;
    background: rgba(255, 255, 255, 0.95);
    color: #6d28d9;
    padding: 8px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 13px;
    z-index: 100;
    border: 1px solid rgba(255, 255, 255, 0.5);
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(12px);
  }

  .back-to-desk:hover {
    background: #ffffff;
    text-decoration: none;
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }

  .portal-wrapper {
    max-width: 1400px;
    margin: 0 auto;
    padding: 15px 12px 30px;
  }

  /* Header */
  .portal-header {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(16px);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 16px;
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  }

  .job-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .job-name {
    font-size: 22px;
    font-weight: 700;
    color: #111827;
    margin: 0;
    letter-spacing: -0.01em;
  }

  .job-meta {
    display: flex;
    gap: 16px;
    font-size: 13px;
    color: #6b7280;
    flex-wrap: wrap;
  }

  .job-meta-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .job-meta-label {
    font-weight: 600;
    color: #374151;
  }

  /* Search & Filter */
  .control-bar {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .search-box {
    flex: 1;
    min-width: 280px;
  }

  .search-input {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.95);
    font-size: 14px;
    color: #111827;
    font-weight: 500;
    transition: all 0.3s ease;
    backdrop-filter: blur(12px);
  }

  .search-input:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    background: #ffffff;
  }

  .search-input::placeholder {
    color: #9ca3af;
    font-weight: 400;
  }

  .status-filter {
    padding: 10px 14px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.95);
    font-size: 14px;
    cursor: pointer;
    color: #111827;
    font-weight: 500;
    transition: all 0.3s ease;
    backdrop-filter: blur(12px);
  }

  .status-filter:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
  }

  .btn-clear {
    padding: 10px 18px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.95);
    color: #6d28d9;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(12px);
  }

  .btn-clear:hover {
    background: #ffffff;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  /* Cargo Table */
  .cargo-table {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .table-header {
    display: grid;
    grid-template-columns: 2fr 1.5fr 1.2fr 1.2fr 1fr 120px;
    gap: 16px;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #6d28d9;
    border: 1px solid rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(16px);
  }

  .cargo-card {
    background: rgba(255, 255, 255, 0.98);
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease;
    backdrop-filter: blur(16px);
  }

  .cargo-card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    transform: translateY(-1px);
  }

  .cargo-card.expanded {
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
  }

  .cargo-summary {
    display: grid;
    grid-template-columns: 2fr 1.5fr 1.2fr 1.2fr 1fr 120px;
    gap: 16px;
    padding: 14px 16px;
    align-items: center;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .cargo-summary:hover {
    background: rgba(248, 250, 252, 0.8);
  }

  .cargo-id {
    font-weight: 700;
    color: #111827;
    font-size: 15px;
    letter-spacing: -0.01em;
  }

  .cargo-type {
    color: #6b7280;
    font-size: 12px;
    margin-top: 2px;
    font-weight: 500;
  }

  .cargo-transporter,
  .cargo-truck,
  .cargo-driver {
    color: #374151;
    font-weight: 600;
  }

  .cargo-status {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all 0.3s ease;
  }

  .status-draft {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #92400e;
    box-shadow: 0 1px 4px rgba(251, 191, 36, 0.2);
  }

  .status-pending {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #92400e;
    box-shadow: 0 1px 4px rgba(251, 191, 36, 0.2);
  }

  .status-loading {
    background: linear-gradient(135deg, #dbeafe, #bfdbfe);
    color: #1e40af;
    box-shadow: 0 1px 4px rgba(59, 130, 246, 0.2);
  }

  .status-in-transit {
    background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
    color: #4338ca;
    box-shadow: 0 1px 4px rgba(99, 102, 241, 0.2);
  }

  .status-completed {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    color: #065f46;
    box-shadow: 0 1px 4px rgba(34, 197, 94, 0.2);
  }

  .cargo-actions {
    display: flex;
    gap: 6px;
    justify-content: flex-end;
  }

  .btn-icon {
    padding: 6px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 11px;
    font-weight: 600;
    color: #374151;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    text-decoration: none;
  }

  .btn-icon:hover {
    background: #f8fafc;
    border-color: #8b5cf6;
    color: #7c3aed;
    text-decoration: none;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  }

  .btn-icon i {
    font-size: 10px;
  }

  /* 50/50 Details Section - Simplified */
  .cargo-details {
    display: none;
    padding: 16px;
    background: rgba(248, 250, 252, 0.9);
    border-top: 1px solid #e5e7eb;
  }

  .cargo-details.show {
    display: block;
  }

  .details-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    align-items: start;
  }

  .details-section {
    position: relative;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e5e7eb;
  }

  .section-title {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    display: flex;
    align-items: center;
    gap: 8px;
    letter-spacing: -0.01em;
  }

  .section-title i {
    font-size: 16px;
    color: #8b5cf6;
  }

  /* Simplified Update Buttons */
  .btn-update {
    padding: 6px 14px;
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .btn-update:hover {
    background: linear-gradient(135deg, #7c3aed, #6d28d9);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
  }

  /* Simplified Text Layout */
  .info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px 16px;
    line-height: 1.4;
  }

  .info-row {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .info-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    color: #6b7280;
    letter-spacing: 0.08em;
  }

  .info-value {
    font-size: 13px;
    color: #111827;
    font-weight: 600;
  }

  .info-value.empty {
    color: #9ca3af;
    font-style: italic;
    font-weight: 400;
  }

  /* Timeline - Simplified */
  .timeline-container {
    margin: 16px 0;
  }

  .timeline-track {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 12px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    margin-bottom: 16px;
  }

  .milestone-item {
    flex: 1;
    text-align: center;
    position: relative;
  }

  .milestone-item:not(:last-child)::after {
    content: "";
    position: absolute;
    top: 12px;
    left: 60%;
    right: -40%;
    height: 2px;
    background: #e5e7eb;
    border-radius: 1px;
  }

  .milestone-item.completed:not(:last-child)::after {
    background: linear-gradient(90deg, #22c55e, #16a34a);
  }

  .milestone-dot {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #e5e7eb;
    margin: 0 auto 6px;
    display: grid;
    place-items: center;
    font-size: 10px;
    color: white;
    position: relative;
    z-index: 2;
    transition: all 0.3s ease;
    border: 2px solid white;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
  }

  .milestone-item.completed .milestone-dot {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    transform: scale(1.05);
  }

  .milestone-item.next .milestone-dot {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1), 0 0 0 0 rgba(59, 130, 246, 0.4); }
    50% { box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1), 0 0 0 6px rgba(59, 130, 246, 0.1); }
  }

  .milestone-label {
    font-size: 10px;
    font-weight: 700;
    color: #374151;
    margin-bottom: 2px;
  }

  .milestone-date {
    font-size: 9px;
    color: #9ca3af;
    font-weight: 500;
  }

  /* Tracking Info - Simplified */
  .tracking-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px 16px;
    margin-bottom: 16px;
  }

  .tracking-comment {
    grid-column: 1 / -1;
    margin-top: 8px;
  }

  /* Buttons */
  .btn-action {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .btn-primary {
    background: linear-gradient(135deg, #7c3aed, #6d28d9);
    color: white;
    box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #6d28d9, #5b21b6);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
  }

  .btn-success {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
  }

  .btn-success:hover {
    background: linear-gradient(135deg, #16a34a, #15803d);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
  }

  .btn-info {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  }

  .btn-info:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  }

  .btn-secondary {
    background: linear-gradient(135deg, #e5e7eb, #d1d5db);
    color: #374151;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .btn-secondary:hover {
    background: linear-gradient(135deg, #d1d5db, #9ca3af);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 16px;
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-content {
    background: white;
    border-radius: 12px;
    padding: 20px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease;
  }

  @keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f3f4f6;
  }

  .modal-title {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    letter-spacing: -0.01em;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 20px;
    color: #9ca3af;
    cursor: pointer;
    padding: 2px;
    transition: all 0.3s ease;
  }

  .modal-close:hover {
    color: #374151;
    transform: scale(1.1);
  }

  /* Form Styles */
  .form-group {
    margin-bottom: 14px;
    position: relative;
  }

  .form-label {
    font-size: 11px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 6px;
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .form-control {
    padding: 8px 12px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    font-size: 13px;
    color: #111827;
    width: 100%;
    background: white;
    transition: all 0.3s ease;
    font-weight: 500;
  }

  .form-control:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }

  .alert {
    padding: 10px 14px;
    border-radius: 8px;
    margin-bottom: 14px;
    font-weight: 500;
    position: relative;
    font-size: 13px;
    border: 1px solid;
  }

  .alert-success {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    color: #065f46;
    border-color: #a7f3d0;
  }

  .alert-danger {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    color: #991b1b;
    border-color: #fecaca;
  }

  .spinner {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Supplier dropdown fixes */
  .form-group {
    position: relative;
    margin-bottom: 14px;
  }

  #transporter-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    margin-top: 4px;
    max-height: 200px;
    overflow-y: auto;
    display: none;
  }

  .dropdown-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f1f5f9;
    transition: background-color 0.2s ease;
  }

  .dropdown-item:last-child {
    border-bottom: none;
  }

  .dropdown-item:hover {
    background-color: #f3f4f6;
  }

  .dropdown-item-name {
    font-weight: 600;
    color: #1e293b;
  }

  .dropdown-item-code {
    font-size: 11px;
    color: #64748b;
  }

  @media (max-width: 1200px) {
    .details-container {
      grid-template-columns: 1fr;
      gap: 16px;
    }
  }

  @media (max-width: 1024px) {
    .table-header,
    .cargo-summary {
      grid-template-columns: 2fr 1.5fr 1fr 1fr 100px;
    }

    .cargo-driver {
      display: none;
    }

    .info-grid,
    .tracking-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .table-header {
      display: none;
    }

    .cargo-summary {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .cargo-actions {
      width: 100%;
    }

    .job-name {
      font-size: 20px;
    }

    .portal-wrapper {
      padding: 12px 10px;
    }

    .form-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<a class="back-to-desk" href="/app">‚Üê Back to Desk</a>

<div class="portal-wrapper">
  <div class="portal-header">
    <div class="job-info-row">
      <h1 class="job-name">{{ doc.name }}</h1>
      <div class="job-meta">
        <div class="job-meta-item">
          <span class="job-meta-label">Customer:</span>
          <span>{{ doc.customer }}</span>
        </div>
        <div class="job-meta-item">
          <span class="job-meta-label">Direction:</span>
          <span>{{ doc.direction or "N/A" }}</span>
        </div>
        <div class="job-meta-item">
          <span class="job-meta-label">Cargo:</span>
          <span>{{ doc.cargo_description or "N/A" }}</span>
        </div>
        <div class="job-meta-item">
          <span class="job-meta-label">Trucks:</span>
          <span>{{ total_cargo }}</span>
        </div>
        <div class="job-meta-item">
          <span class="job-meta-label">Date:</span>
          <span>{{ doc.date_created.strftime('%d-%b-%y') if doc.date_created else 'N/A' }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="control-bar">
    <div class="search-box">
      <input type="text" class="search-input" id="searchInput" placeholder="Search by container, truck, driver or transporter...">
    </div>
    <select class="status-filter" id="statusFilter">
      <option value="">All Statuses</option>
      <option value="draft">Draft</option>
      <option value="pending">Pending</option>
      <option value="loading">Loading</option>
      <option value="in-transit">In Transit</option>
      <option value="completed">Completed</option>
    </select>
    <button class="btn-clear" onclick="clearFilters()">Clear</button>
  </div>

  <div class="cargo-table">
    <div class="table-header">
      <div>CARGO</div>
      <div>TRANSPORTER</div>
      <div>TRUCK REG</div>
      <div>DRIVER NAME</div>
      <div>STATUS</div>
      <div>ACTIONS</div>
    </div>

    {% for cargo in doc.cargo_parcel_details %}
    {% set cargo_status %}
      {% if cargo.is_completed %}completed
      {% elif cargo.is_offloaded or cargo.is_loaded %}in-transit
      {% elif cargo.is_booked %}loading
      {% elif cargo.truck_reg_no %}pending
      {% else %}draft
      {% endif %}
    {% endset %}

    <div class="cargo-card" 
         data-cargo-idx="{{ loop.index0 }}"
         data-status="{{ cargo_status.strip() }}"
         data-search="{{ (cargo.container_number or cargo.cargo_item_description or '') | lower }} {{ (cargo.transporter or '') | lower }} {{ (cargo.truck_reg_no or '') | lower }} {{ (cargo.driver_name or '') | lower }}">
      
      <div class="cargo-summary" onclick="toggleDetails({{ loop.index0 }})">
        <div>
          <div class="cargo-id">
            {% if cargo.container_number %}
              {{ cargo.container_number }}
            {% else %}
              {{ cargo.cargo_item_description or ("Cargo " ~ loop.index) }}
            {% endif %}
          </div>
          <div class="cargo-type">{{ cargo.container_type or (cargo.cargo_quantity|string ~ " " ~ (cargo.cargo_uom or "")) }}</div>
        </div>
        <div class="cargo-transporter">{{ cargo.transporter or "-" }}</div>
        <div class="cargo-truck">{{ cargo.truck_reg_no or "-" }}</div>
        <div class="cargo-driver">{{ cargo.driver_name or "-" }}</div>
        <div>
          <span class="cargo-status status-{{ cargo_status.strip() }}">
            {{ cargo_status.strip().upper() }}
          </span>
        </div>
        <div class="cargo-actions" onclick="event.stopPropagation()">
          {% if not cargo.is_truck_required %}
            <button class="btn-icon" onclick="enableTrucking({{ loop.index0 }})" title="Enable Trucking">
              <i class="fa fa-truck"></i>
            </button>
          {% elif not cargo.truck_reg_no %}
            <button class="btn-icon" onclick="showTruckForm({{ loop.index0 }})" title="Assign Truck">
              <i class="fa fa-plus"></i> Add
            </button>
          {% else %}
            <button class="btn-icon" onclick="toggleDetails({{ loop.index0 }})" title="View Details">
              Details
            </button>
          {% endif %}
        </div>
      </div>

      <div class="cargo-details" id="details-{{ loop.index0 }}">
        <div class="details-container">
          <!-- Truck Assignment Section -->
          <div class="details-section">
            <div class="section-header">
              <div class="section-title">
                <i class="fa fa-truck"></i> Truck Assignment
              </div>
              <button class="btn-update" onclick="openTruckModal({{ loop.index0 }})">Update</button>
            </div>
            
            <div class="info-grid">
              <div class="info-row">
                <div class="info-label">Transporter</div>
                <div class="info-value {{ 'empty' if not cargo.transporter }}">{{ cargo.transporter or "Not assigned" }}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Truck Registration</div>
                <div class="info-value {{ 'empty' if not cargo.truck_reg_no }}">{{ cargo.truck_reg_no or "Not assigned" }}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Trailer Registration</div>
                <div class="info-value {{ 'empty' if not cargo.trailer_reg_no }}">{{ cargo.trailer_reg_no or "Not provided" }}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Driver Name</div>
                <div class="info-value {{ 'empty' if not cargo.driver_name }}">{{ cargo.driver_name or "Not assigned" }}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Contact 1</div>
                <div class="info-value {{ 'empty' if not cargo.driver_contact_no }}">{{ cargo.driver_contact_no or "Not provided" }}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Contact 2</div>
                <div class="info-value {{ 'empty' if not cargo.driver_contact_no_2 }}">{{ cargo.driver_contact_no_2 or "Not provided" }}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Passport No</div>
                <div class="info-value {{ 'empty' if not cargo.driver_passport_no }}">{{ cargo.driver_passport_no or "Not provided" }}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Licence No</div>
                <div class="info-value {{ 'empty' if not cargo.driver_licence_no }}">{{ cargo.driver_licence_no or "Not provided" }}</div>
              </div>
            </div>
          </div>

          <!-- Tracking & Timeline Section -->
          <div class="details-section">
            <div class="section-header">
              <div class="section-title">
                <i class="fa fa-map-marker"></i> Tracking & Timeline
              </div>
              <button class="btn-update" onclick="openTrackingModal({{ loop.index0 }})">Update</button>
            </div>
            
            <div class="timeline-container">
              <div class="timeline-track">
                <div class="milestone-item {% if cargo.is_booked %}completed{% elif cargo.is_truck_required and cargo.truck_reg_no %}next{% endif %}">
                  <div class="milestone-dot">
                    {% if cargo.is_booked %}<i class="fa fa-check"></i>{% endif %}
                  </div>
                  <div class="milestone-label">Booked</div>
                  {% if cargo.booked_on_date %}
                  <div class="milestone-date">{{ cargo.booked_on_date.strftime('%d-%b') }}</div>
                  {% endif %}
                </div>

                <div class="milestone-item {% if cargo.is_loaded %}completed{% elif cargo.is_booked %}next{% endif %}">
                  <div class="milestone-dot">
                    {% if cargo.is_loaded %}<i class="fa fa-check"></i>{% endif %}
                  </div>
                  <div class="milestone-label">Loaded</div>
                  {% if cargo.loaded_on_date %}
                  <div class="milestone-date">{{ cargo.loaded_on_date.strftime('%d-%b') }}</div>
                  {% endif %}
                </div>

                <div class="milestone-item {% if cargo.is_offloaded %}completed{% elif cargo.is_loaded %}next{% endif %}">
                  <div class="milestone-dot">
                    {% if cargo.is_offloaded %}<i class="fa fa-check"></i>{% endif %}
                  </div>
                  <div class="milestone-label">Offloaded</div>
                  {% if cargo.offloaded_on_date %}
                  <div class="milestone-date">{{ cargo.offloaded_on_date.strftime('%d-%b') }}</div>
                  {% endif %}
                </div>

                {% if cargo.to_be_returned %}
                <div class="milestone-item {% if cargo.is_returned %}completed{% elif cargo.is_offloaded %}next{% endif %}">
                  <div class="milestone-dot">
                    {% if cargo.is_returned %}<i class="fa fa-check"></i>{% endif %}
                  </div>
                  <div class="milestone-label">Returned</div>
                  {% if cargo.returned_on_date %}
                  <div class="milestone-date">{{ cargo.returned_on_date.strftime('%d-%b') }}</div>
                  {% endif %}
                </div>
                {% endif %}

                <div class="milestone-item {% if cargo.is_completed %}completed{% elif (cargo.to_be_returned and cargo.is_returned) or (not cargo.to_be_returned and cargo.is_offloaded) %}next{% endif %}">
                  <div class="milestone-dot">
                    {% if cargo.is_completed %}<i class="fa fa-check"></i>{% endif %}
                  </div>
                  <div class="milestone-label">Complete</div>
                  {% if cargo.completed_on_date %}
                  <div class="milestone-date">{{ cargo.completed_on_date.strftime('%d-%b') }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="tracking-grid">
              <div class="info-row">
                <div class="info-label">Current Location</div>
                <div class="info-value {{ 'empty' if not cargo.truck_location }}">{{ cargo.truck_location or "Not updated" }}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Last Updated</div>
                <div class="info-value {{ 'empty' if not cargo.updated_on }}">{{ cargo.updated_on.strftime('%d-%b-%y %H:%M') if cargo.updated_on else "-" }}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Updated By</div>
                <div class="info-value {{ 'empty' if not cargo.updated_by }}">{{ cargo.updated_by or "-" }}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Load By Date</div>
                <div class="info-value {{ 'empty' if not cargo.load_by_date }}">{{ cargo.load_by_date.strftime('%d-%b-%y') if cargo.load_by_date else "Not set" }}</div>
              </div>
              <div class="info-row tracking-comment">
                <div class="info-label">Tracking Comment</div>
                <div class="info-value {{ 'empty' if not cargo.tracking_comment }}">{{ cargo.tracking_comment or "No comments" }}</div>
              </div>
            </div>

            <div class="btn-group">
              {% if not cargo.is_booked and cargo.truck_reg_no %}
                <button class="btn-action btn-success" onclick="updateMilestone({{ loop.index0 }}, 'booked')">
                  <i class="fa fa-check"></i> Mark Booked
                </button>
              {% elif not cargo.is_loaded and cargo.is_booked %}
                <button class="btn-action btn-success" onclick="updateMilestone({{ loop.index0 }}, 'loaded')">
                  <i class="fa fa-upload"></i> Mark Loaded
                </button>
              {% elif not cargo.is_offloaded and cargo.is_loaded %}
                <button class="btn-action btn-success" onclick="updateMilestone({{ loop.index0 }}, 'offloaded')">
                  <i class="fa fa-download"></i> Mark Offloaded
                </button>
              {% elif cargo.to_be_returned and not cargo.is_returned and cargo.is_offloaded %}
                <button class="btn-action btn-success" onclick="updateMilestone({{ loop.index0 }}, 'returned')">
                  <i class="fa fa-undo"></i> Mark Returned
                </button>
              {% elif not cargo.is_completed and ((cargo.to_be_returned and cargo.is_returned) or (not cargo.to_be_returned and cargo.is_offloaded)) %}
                <button class="btn-action btn-success" onclick="updateMilestone({{ loop.index0 }}, 'completed')">
                  <i class="fa fa-flag-checkered"></i> Mark Complete
                </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Truck Details Modal -->
<div class="modal-overlay" id="truckModal">
  <div class="modal-content modal-compact modal-wide">
    <div class="modal-header">
      <h3 class="modal-title">Update Truck Details</h3>
      <button class="modal-close" onclick="closeTruckModal()">&times;</button>
    </div>
    <form id="truckForm" onsubmit="saveTruckDetails(event)">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">TRANSPORTER <span style="color: #ef4444;">*</span></label>
          <input type="text" class="form-control" id="transporterInput" 
                 placeholder="Start typing to search..." required autocomplete="off">
          <div id="transporter-dropdown"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label">TRUCK REGISTRATION <span style="color: #ef4444;">*</span></label>
          <input type="text" class="form-control" id="truckRegInput" 
                 placeholder="e.g., ABC-123-GP" required style="text-transform: uppercase;">
        </div>
        
        <div class="form-group">
          <label class="form-label">TRAILER REGISTRATION</label>
          <input type="text" class="form-control" id="trailerRegInput" 
                 placeholder="e.g., XYZ-456-GP" style="text-transform: uppercase;">
        </div>
        
        <div class="form-group">
          <label class="form-label">DRIVER NAME <span style="color: #ef4444;">*</span></label>
          <input type="text" class="form-control" id="driverNameInput" 
                 placeholder="Full name" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">CONTACT 1 <span style="color: #ef4444;">*</span></label>
          <input type="text" class="form-control" id="contact1Input" 
                 placeholder="0771234567" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">CONTACT 2</label>
          <input type="text" class="form-control" id="contact2Input" 
                 placeholder="0771234567">
        </div>
        
        <div class="form-group">
          <label class="form-label">PASSPORT NO</label>
          <input type="text" class="form-control" id="passportInput" 
                 placeholder="Passport number" style="text-transform: uppercase;">
        </div>
        
        <div class="form-group">
          <label class="form-label">LICENCE NO</label>
          <input type="text" class="form-control" id="licenceInput" 
                 placeholder="Licence number" style="text-transform: uppercase;">
        </div>
      </div>
      
      <div class="btn-group">
        <button type="button" class="btn-action btn-secondary" onclick="closeTruckModal()">
          CANCEL
        </button>
        <button type="submit" class="btn-action btn-primary" id="saveTruckBtn">
          <span class="spinner" style="display: none;"></span>
          SAVE DETAILS
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Tracking Modal -->
<div class="modal-overlay" id="trackingModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Update Tracking</h3>
      <button class="modal-close" onclick="closeTrackingModal()">&times;</button>
    </div>
    <form id="trackingForm" onsubmit="saveTracking(event)">
      <div class="form-group">
        <label class="form-label">Current Location</label>
        <input type="text" name="truck_location" class="form-control" placeholder="e.g., Beitbridge Border Post">
      </div>
      <div class="form-group">
        <label class="form-label">Tracking Comment</label>
        <textarea name="comment" class="form-control" rows="3" placeholder="Add any updates or notes..."></textarea>
      </div>
      <div class="btn-group">
        <button type="submit" class="btn-action btn-info">
          <i class="fa fa-map-marker"></i> Update Tracking
        </button>
        <button type="button" class="btn-action btn-secondary" onclick="closeTrackingModal()">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const jobName = '{{ doc.name }}';
  let currentCargoIdx = null;
  let allSuppliers = [];

  // ========================================
  // SIMPLIFIED SUPPLIER SEARCH
  // ========================================
  
  function loadSuppliers() {
    if (allSuppliers.length > 0) return;
    
    frappe.call({
      method: 'frappe.client.get_list',
      args: {
        doctype: 'Supplier',
        filters: { disabled: 0 },
        fields: ['name', 'supplier_name'],
        limit_page_length: 500,
        order_by: 'supplier_name asc'
      },
      callback: (r) => {
        if (r.message) {
          allSuppliers = r.message;
          console.log('Loaded suppliers:', allSuppliers.length);
        }
      },
      error: (err) => {
        console.error('Error loading suppliers:', err);
      }
    });
  }

  function setupSupplierSearch() {
    const input = document.getElementById('transporterInput');
    const dropdown = document.getElementById('transporter-dropdown');
    
    if (!input || !dropdown) {
      console.error('Supplier search elements not found');
      return;
    }
    
    // Load suppliers when input is focused
    input.addEventListener('focus', function() {
      loadSuppliers();
    });
    
    // Filter and show suppliers as user types
    input.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase().trim();
      
      if (searchTerm.length < 2) {
        dropdown.style.display = 'none';
        return;
      }
      
      const filtered = allSuppliers.filter(supplier => {
        const name = (supplier.supplier_name || '').toLowerCase();
        const code = (supplier.name || '').toLowerCase();
        return name.includes(searchTerm) || code.includes(searchTerm);
      });
      
      if (filtered.length > 0) {
        dropdown.innerHTML = '';
        filtered.forEach(supplier => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.setAttribute('data-value', supplier.name);
          
          item.innerHTML = `
            <div class="dropdown-item-name">${supplier.supplier_name || supplier.name}</div>
            ${supplier.supplier_name ? `<div class="dropdown-item-code">${supplier.name}</div>` : ''}
          `;
          
          item.addEventListener('click', function() {
            input.value = supplier.supplier_name || supplier.name;
            input.setAttribute('data-supplier-id', supplier.name);
            dropdown.style.display = 'none';
          });
          
          dropdown.appendChild(item);
        });
        dropdown.style.display = 'block';
      } else {
        dropdown.style.display = 'none';
      }
    });
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!input.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });
  }

  // ========================================
  // MODAL FUNCTIONS
  // ========================================
  
  function openTruckModal(idx) {
    currentCargoIdx = idx;
    
    // Reset form
    const form = document.getElementById('truckForm');
    form.reset();
    
    // Clear supplier data
    const transporterInput = document.getElementById('transporterInput');
    transporterInput.removeAttribute('data-supplier-id');
    
    // Hide dropdown
    document.getElementById('transporter-dropdown').style.display = 'none';
    
    // Load suppliers
    loadSuppliers();
    
    // Show modal
    document.getElementById('truckModal').style.display = 'flex';
  }

  function closeTruckModal() {
    document.getElementById('truckModal').style.display = 'none';
    document.getElementById('transporter-dropdown').style.display = 'none';
    currentCargoIdx = null;
  }

  function saveTruckDetails(event) {
    event.preventDefault();
    
    if (currentCargoIdx === null) return;
    
    const button = document.getElementById('saveTruckBtn');
    const spinner = button.querySelector('.spinner');
    
    // Get supplier ID or use display name
    const transporterInput = document.getElementById('transporterInput');
    const supplierId = transporterInput.getAttribute('data-supplier-id');
    const supplierName = transporterInput.value;
    
    const data = {
      job: jobName,
      cargo_idx: currentCargoIdx,
      transporter: supplierId || supplierName,
      truck_reg_no: document.getElementById('truckRegInput').value.toUpperCase(),
      trailer_reg_no: document.getElementById('trailerRegInput').value.toUpperCase(),
      driver_name: document.getElementById('driverNameInput').value,
      driver_contact_no: document.getElementById('contact1Input').value,
      driver_contact_no_2: document.getElementById('contact2Input').value,
      driver_passport_no: document.getElementById('passportInput').value.toUpperCase(),
      driver_licence_no: document.getElementById('licenceInput').value.toUpperCase()
    };
    
    // Simple validation
    if (!data.transporter || !data.truck_reg_no || !data.driver_name || !data.driver_contact_no) {
      alert('Please fill all required fields');
      return;
    }
    
    // Show loading
    button.disabled = true;
    spinner.style.display = 'inline-block';
    
    frappe.call({
      method: 'freightmas.www.truck_portal.update_truck_details',
      args: data,
      callback: (r) => {
        if (r.message && r.message.success) {
          closeTruckModal();
          alert('Truck details updated successfully!');
          setTimeout(() => location.reload(), 1000);
        } else {
          alert('Error updating truck details');
        }
      },
      error: (err) => {
        console.error('Error:', err);
        alert('Error updating truck details');
      },
      always: () => {
        button.disabled = false;
        spinner.style.display = 'none';
      }
    });
  }

  // ========================================
  // INITIALIZE
  // ========================================
  
  frappe.ready(function() {
    setupSupplierSearch();
    setupFilters();
  });

  function toggleDetails(idx) {
    const details = document.getElementById(`details-${idx}`);
    const card = details.closest('.cargo-card');
    const isOpen = details.classList.contains('show');
    
    document.querySelectorAll('.cargo-details').forEach(d => d.classList.remove('show'));
    document.querySelectorAll('.cargo-card').forEach(c => c.classList.remove('expanded'));
    
    if (!isOpen) {
      details.classList.add('show');
      card.classList.add('expanded');
    }
  }

  function setupFilters() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    
    searchInput.addEventListener('input', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
  }

  function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusValue = document.getElementById('statusFilter').value;
    
    document.querySelectorAll('.cargo-card').forEach(card => {
      const searchData = card.dataset.search || '';
      const status = card.dataset.status || '';
      
      const matchesSearch = !searchTerm || searchData.includes(searchTerm);
      const matchesStatus = !statusValue || status === statusValue;
      
      card.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
    });
  }

  function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    applyFilters();
  }

  function openTrackingModal(idx) {
    currentCargoIdx = idx;
    
    frappe.call({
      method: 'freightmas.www.truck_portal.get_cargo_details',
      args: { job: jobName, cargo_idx: idx },
      callback: function(r) {
        if (r.message) {
          const form = document.getElementById('trackingForm');
          const data = r.message.tracking_info;
          
          form.querySelector('[name="truck_location"]').value = data.truck_location || '';
          form.querySelector('[name="comment"]').value = data.tracking_comment || '';
          
          document.getElementById('trackingModal').style.display = 'flex';
        }
      }
    });
  }

  function closeTrackingModal() {
    document.getElementById('trackingModal').style.display = 'none';
    currentCargoIdx = null;
  }

  function saveTracking(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const button = form.querySelector('button[type="submit"]');
    
    button.disabled = true;
    button.innerHTML = '<span class="spinner"></span> Updating...';

    frappe.call({
      method: 'freightmas.www.truck_portal.update_tracking',
      args: {
        job: jobName,
        cargo_idx: currentCargoIdx,
        truck_location: formData.get('truck_location'),
        comment: formData.get('comment')
      },
      callback: function(r) {
        if (r.message.success) {
          showAlert('success', r.message.message);
          closeTrackingModal();
          setTimeout(() => location.reload(), 1000);
        }
      },
      error: function(err) {
        showAlert('danger', 'Failed to update tracking: ' + (err.message || 'Unknown error'));
      },
      always: function() {
        button.disabled = false;
        button.innerHTML = '<i class="fa fa-map-marker"></i> Update Tracking';
      }
    });
  }

  function updateMilestone(idx, milestone) {
    const comment = prompt(`Enter comment for ${milestone} milestone (optional):`);
    
    frappe.call({
      method: 'freightmas.www.truck_portal.update_milestone',
      args: {
        job: jobName,
        cargo_idx: idx,
        milestone: milestone,
        date: new Date().toISOString().split('T')[0],
        comment: comment
      },
      callback: function(r) {
        if (r.message.success) {
          showAlert('success', r.message.message);
          setTimeout(() => location.reload(), 1000);
        }
      },
      error: function(err) {
        showAlert('danger', 'Failed to update milestone: ' + (err.message || 'Unknown error'));
      }
    });
  }

  window.enableTrucking = function(idx) {
    if (!confirm('Enable trucking for this cargo?')) return;
    
    frappe.call({
      method: 'freightmas.www.truck_portal.enable_trucking_for_cargo',
      args: { job: jobName, cargo_idx: idx },
      callback: function(r) {
        if (r.message.success) {
          showAlert('success', r.message.message);
          setTimeout(() => location.reload(), 1000);
        }
      },
      error: function(err) {
        showAlert('danger', 'Failed to enable trucking: ' + (err.message || 'Unknown error'));
      }
    });
  };

  window.showTruckForm = function(idx) {
    openTruckModal(idx);
  };

  function showAlert(type, message) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    document.querySelector('.portal-header').after(alert);
    setTimeout(() => alert.remove(), 5000);
  }

  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay')) {
      closeTruckModal();
      closeTrackingModal();
    }
  });
</script>
{% endblock %}