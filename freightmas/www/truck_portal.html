{% extends "templates/web.html" %}

{% block title %}{{ doc.name }} - Truck Portal{% endblock %}

{% block page_content %}
<style>
  body {
    background-color: #f5f7fa;
  }
  
  .page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  
  .page-header h1 {
    margin: 0;
    font-size: 28px;
    font-weight: 600;
  }
  
  .page-header .meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  
  .page-header .meta-item {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .page-header .meta-item i {
    font-size: 20px;
    opacity: 0.9;
  }
  
  /* Search and Filter Bar */
  .toolbar {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }
  
  .search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
  }
  
  .search-box input {
    width: 100%;
    padding: 10px 40px 10px 15px;
    border: 2px solid #e0e6ed;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.3s;
  }
  
  .search-box input:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .search-box i {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #8897aa;
  }
  
  .filter-group {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  .filter-select {
    padding: 10px 15px;
    border: 2px solid #e0e6ed;
    border-radius: 6px;
    font-size: 14px;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .filter-select:focus {
    border-color: #667eea;
    outline: none;
  }
  
  /* Cargo Cards */
  .cargo-card {
    background: white;
    border-radius: 12px;
    padding: 0;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
    transition: all 0.3s;
  }
  
  .cargo-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  }
  
  .cargo-header {
    background: #f8f9fb;
    padding: 20px;
    border-bottom: 2px solid #e0e6ed;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
  }
  
  .cargo-title {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
  }
  
  .cargo-title h5 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #1e293b;
  }
  
  .cargo-title .cargo-icon {
    font-size: 24px;
    color: #667eea;
  }
  
  .cargo-meta {
    font-size: 13px;
    color: #64748b;
    margin-top: 5px;
  }
  
  /* Status Badges */
  .status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  
  .status-badge i {
    font-size: 10px;
  }
  
  .status-pending { 
    background: #fef3c7; 
    color: #92400e; 
    border: 1px solid #fcd34d;
  }
  
  .status-approved { 
    background: #d1fae5; 
    color: #065f46; 
    border: 1px solid #6ee7b7;
  }
  
  .status-rejected { 
    background: #fee2e2; 
    color: #991b1b; 
    border: 1px solid #fca5a5;
  }
  
  .status-booked { 
    background: #dbeafe; 
    color: #1e40af; 
    border: 1px solid #93c5fd;
  }
  
  .status-loading { 
    background: #e9d5ff; 
    color: #6b21a8; 
    border: 1px solid #c084fc;
  }
  
  .status-in-transit { 
    background: #fed7aa; 
    color: #9a3412; 
    border: 1px solid #fdba74;
  }
  
  .status-offloaded { 
    background: #d6d3d1; 
    color: #44403c; 
    border: 1px solid #a8a29e;
  }
  
  .status-delivered { 
    background: #e2e8f0; 
    color: #334155; 
    border: 1px solid #cbd5e1;
  }
  
  /* Truck Info - Always Visible */
  .truck-info-visible {
    padding: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
  }
  
  .info-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: #f8f9fb;
    border-radius: 8px;
    border-left: 3px solid #667eea;
  }
  
  .info-item i {
    font-size: 20px;
    color: #667eea;
    width: 24px;
    text-align: center;
  }
  
  .info-item .label {
    font-size: 12px;
    color: #64748b;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .info-item .value {
    font-size: 15px;
    color: #1e293b;
    font-weight: 600;
    margin-top: 2px;
  }
  
  /* Collapsible Section */
  .details-toggle {
    padding: 15px 20px;
    background: #fafbfc;
    border-top: 1px solid #e0e6ed;
    border-bottom: 1px solid #e0e6ed;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s;
  }
  
  .details-toggle:hover {
    background: #f1f3f5;
  }
  
  .details-toggle .toggle-text {
    font-size: 14px;
    font-weight: 600;
    color: #475569;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .details-toggle .toggle-icon {
    transition: transform 0.3s;
    color: #667eea;
  }
  
  .details-toggle.active .toggle-icon {
    transform: rotate(180deg);
  }
  
  .details-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
  }
  
  .details-content.show {
    max-height: 800px;
  }
  
  .details-body {
    padding: 20px;
    background: white;
  }
  
  .details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .detail-item {
    padding: 12px;
    background: #f8f9fb;
    border-radius: 6px;
  }
  
  .detail-item .label {
    font-size: 12px;
    color: #64748b;
    font-weight: 500;
    margin-bottom: 4px;
  }
  
  .detail-item .value {
    font-size: 14px;
    color: #1e293b;
    font-weight: 600;
  }
  
  /* Action Buttons */
  .action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    padding-top: 15px;
    border-top: 1px solid #e0e6ed;
  }
  
  .btn-action {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  
  .btn-success {
    background: #10b981;
    color: white;
  }
  
  .btn-success:hover {
    background: #059669;
  }
  
  .btn-danger {
    background: #ef4444;
    color: white;
  }
  
  .btn-danger:hover {
    background: #dc2626;
  }
  
  .btn-primary {
    background: #3b82f6;
    color: white;
  }
  
  .btn-primary:hover {
    background: #2563eb;
  }
  
  .btn-info {
    background: #06b6d4;
    color: white;
  }
  
  .btn-info:hover {
    background: #0891b2;
  }
  
  /* No Booking Alert */
  .no-booking-alert {
    padding: 20px;
    background: #fef3c7;
    border: 2px dashed #f59e0b;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
  }
  
  .no-booking-alert .message {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #92400e;
    font-weight: 500;
  }
  
  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #64748b;
  }
  
  .empty-state i {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.3;
  }
  
  .empty-state h4 {
    font-size: 20px;
    margin-bottom: 10px;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .page-header h1 {
      font-size: 22px;
    }
    
    .toolbar {
      flex-direction: column;
    }
    
    .search-box {
      width: 100%;
    }
    
    .truck-info-visible {
      grid-template-columns: 1fr;
    }
    
    .cargo-header {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>

<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
  
  <!-- Page Header -->
  <div class="page-header">
    <h1><i class="fa fa-ship"></i> {{ doc.name }}</h1>
    <div class="meta">
      <div class="meta-item">
        <i class="fa fa-user"></i>
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Customer</div>
          <div style="font-size: 16px; font-weight: 600;">{{ doc.customer }}</div>
        </div>
      </div>
      <div class="meta-item">
        <i class="fa fa-route"></i>
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Route</div>
          <div style="font-size: 16px; font-weight: 600;">{{ doc.port_of_loading }} â†’ {{ doc.port_of_discharge }}</div>
        </div>
      </div>
      <div class="meta-item">
        <i class="fa fa-calendar"></i>
        <div>
          <div style="font-size: 12px; opacity: 0.8;">ETA</div>
          <div style="font-size: 16px; font-weight: 600;">{{ frappe.format_date(doc.eta) if doc.eta else '-' }}</div>
        </div>
      </div>
      <div class="meta-item">
        <i class="fa fa-box"></i>
        <div>
          <div style="font-size: 12px; opacity: 0.8;">Cargo</div>
          <div style="font-size: 16px; font-weight: 600;">{{ doc.cargo_description or '-' }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filter Toolbar -->
  <div class="toolbar">
    <div class="search-box">
      <input type="text" id="search-input" placeholder="ðŸ” Search by container, truck, driver, or transporter...">
      <i class="fa fa-search"></i>
    </div>
    <div class="filter-group">
      <select class="filter-select" id="status-filter">
        <option value="">All Statuses</option>
        <option value="Pending">Pending</option>
        <option value="Approved">Approved</option>
        <option value="Rejected">Rejected</option>
        <option value="Booked">Booked</option>
        <option value="Loading">Loading</option>
        <option value="In Transit">In Transit</option>
        <option value="Offloaded">Offloaded</option>
        <option value="Delivered">Delivered</option>
      </select>
      <button class="btn-action btn-primary" onclick="clearFilters()">
        <i class="fa fa-redo"></i> Clear Filters
      </button>
    </div>
  </div>

  <!-- Cargo Cards -->
  <div id="cargo-container">
    {% if doc.cargo_parcel_details %}
      {% for cargo in doc.cargo_parcel_details %}
      <div class="cargo-card" 
           data-container="{{ cargo.container_number or '' }}" 
           data-truck="{{ cargo.truck_reg_no or '' }}"
           data-driver="{{ cargo.driver_name or '' }}"
           data-transporter="{{ cargo.transporter or '' }}"
           data-status="{{ cargo.booking_status or 'No Booking' }}">
        
        <!-- Cargo Header -->
        <div class="cargo-header">
          <div class="cargo-title">
            <span class="cargo-icon">
              {% if cargo.cargo_type == 'Containerised' %}
                <i class="fa fa-box"></i>
              {% else %}
                <i class="fa fa-boxes"></i>
              {% endif %}
            </span>
            <div>
              <h5>
                {% if cargo.cargo_type == 'Containerised' %}
                  {{ cargo.container_number }} ({{ cargo.container_type }})
                {% else %}
                  {{ cargo.cargo_quantity }} x {{ cargo.cargo_item_description }}
                {% endif %}
              </h5>
              <div class="cargo-meta">
                {% if cargo.weight %}Weight: {{ cargo.weight }} kg{% endif %}
                {% if cargo.cargo_type == 'Containerised' and cargo.seal_no %}
                  â€¢ Seal: {{ cargo.seal_no }}
                {% endif %}
              </div>
            </div>
          </div>
          <div>
            {% if cargo.is_truck_required %}
              <span class="status-badge status-{{ (cargo.booking_status or 'pending')|lower|replace(' ', '-') }}">
                <i class="fa fa-circle"></i>
                {{ cargo.booking_status or 'No Booking' }}
              </span>
            {% else %}
              <span class="status-badge" style="background: #e2e8f0; color: #64748b; border: 1px solid #cbd5e1;">
                <i class="fa fa-times-circle"></i>
                No Truck Required
              </span>
            {% endif %}
          </div>
        </div>

        {% if cargo.is_truck_required %}
          {% if cargo.transporter %}
            <!-- Truck Info - Always Visible -->
            <div class="truck-info-visible">
              <div class="info-item">
                <i class="fa fa-building"></i>
                <div>
                  <div class="label">Transporter</div>
                  <div class="value">{{ cargo.transporter }}</div>
                </div>
              </div>
              <div class="info-item">
                <i class="fa fa-truck"></i>
                <div>
                  <div class="label">Truck Registration</div>
                  <div class="value">{{ cargo.truck_reg_no or '-' }}</div>
                </div>
              </div>
              <div class="info-item">
                <i class="fa fa-user"></i>
                <div>
                  <div class="label">Driver Name</div>
                  <div class="value">{{ cargo.driver_name or '-' }}</div>
                </div>
              </div>
            </div>

            <!-- Collapsible Details Toggle -->
            <div class="details-toggle" onclick="toggleDetails(this)">
              <span class="toggle-text">
                <i class="fa fa-info-circle"></i>
                View More Details
              </span>
              <i class="fa fa-chevron-down toggle-icon"></i>
            </div>

            <!-- Collapsible Details Content -->
            <div class="details-content">
              <div class="details-body">
                <div class="details-grid">
                  {% if cargo.trailer_reg_no %}
                  <div class="detail-item">
                    <div class="label">Trailer Registration</div>
                    <div class="value">{{ cargo.trailer_reg_no }}</div>
                  </div>
                  {% endif %}
                  
                  {% if cargo.driver_contact_no %}
                  <div class="detail-item">
                    <div class="label">Driver Contact</div>
                    <div class="value">{{ cargo.driver_contact_no }}</div>
                  </div>
                  {% endif %}
                  
                  {% if cargo.driver_contact_no_2 %}
                  <div class="detail-item">
                    <div class="label">Alt Contact</div>
                    <div class="value">{{ cargo.driver_contact_no_2 }}</div>
                  </div>
                  {% endif %}
                  
                  {% if cargo.driver_passport_no %}
                  <div class="detail-item">
                    <div class="label">Passport Number</div>
                    <div class="value">{{ cargo.driver_passport_no }}</div>
                  </div>
                  {% endif %}
                  
                  {% if cargo.driver_licence_no %}
                  <div class="detail-item">
                    <div class="label">Licence Number</div>
                    <div class="value">{{ cargo.driver_licence_no }}</div>
                  </div>
                  {% endif %}
                  
                  {% if cargo.truck_location %}
                  <div class="detail-item">
                    <div class="label">Current Location</div>
                    <div class="value">
                      <i class="fa fa-map-marker-alt" style="color: #ef4444;"></i>
                      {{ cargo.truck_location }}
                    </div>
                  </div>
                  {% endif %}
                  
                  {% if cargo.updated_on %}
                  <div class="detail-item">
                    <div class="label">Last Updated</div>
                    <div class="value">{{ frappe.utils.pretty_date(cargo.updated_on) }}</div>
                  </div>
                  {% endif %}
                </div>

                {% if cargo.tracking_comment %}
                <div style="padding: 15px; background: #f1f5f9; border-radius: 6px; margin-bottom: 20px;">
                  <div style="font-size: 12px; color: #64748b; font-weight: 600; margin-bottom: 5px;">
                    LATEST UPDATE
                  </div>
                  <div style="font-size: 14px; color: #1e293b;">
                    {{ cargo.tracking_comment }}
                  </div>
                </div>
                {% endif %}

                <!-- Action Buttons -->
                <div class="action-buttons">
                  {% if cargo.booking_status == 'Pending' and frappe.session.user == doc.owner %}
                    <button class="btn-action btn-success approve-btn" data-cargo-idx="{{ loop.index0 }}">
                      <i class="fa fa-check"></i> Approve
                    </button>
                    <button class="btn-action btn-danger reject-btn" data-cargo-idx="{{ loop.index0 }}">
                      <i class="fa fa-times"></i> Reject
                    </button>
                  {% endif %}

                  {% if cargo.booking_status == 'Approved' and frappe.session.user == doc.owner %}
                    <button class="btn-action btn-primary book-btn" data-cargo-idx="{{ loop.index0 }}">
                      <i class="fa fa-check-circle"></i> Mark as Booked
                    </button>
                  {% endif %}

                  {% if cargo.booking_status in ['Booked', 'Loading', 'In Transit', 'Offloaded'] %}
                    <button class="btn-action btn-info update-tracking-btn" data-cargo-idx="{{ loop.index0 }}">
                      <i class="fa fa-route"></i> Update Tracking
                    </button>
                  {% endif %}
                </div>
              </div>
            </div>

          {% else %}
            <!-- No Booking Yet -->
            <div class="no-booking-alert">
              <div class="message">
                <i class="fa fa-exclamation-triangle" style="font-size: 24px;"></i>
                <span>Truck required but not yet booked</span>
              </div>
              <button class="btn-action btn-success add-booking-btn" data-cargo-idx="{{ loop.index0 }}">
                <i class="fa fa-plus"></i> Add Truck Booking
              </button>
            </div>
          {% endif %}
        {% endif %}
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <i class="fa fa-box-open"></i>
        <h4>No Cargo Details</h4>
        <p>No cargo information available for this forwarding job.</p>
      </div>
    {% endif %}
  </div>

</div>

<!-- Add Booking Modal -->
<div class="modal fade" id="addBookingModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content" style="border-radius: 12px; border: none;">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px 12px 0 0;">
        <h5 class="modal-title" style="font-weight: 600;">
          <i class="fa fa-truck"></i> Add Truck Booking
        </h5>
        <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 1;">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body" style="padding: 30px;">
        <input type="hidden" id="booking-cargo-idx">
        
        <div class="form-group">
          <label style="font-weight: 600; color: #1e293b;">
            Transporter <span style="color: #ef4444;">*</span>
          </label>
          <div class="input-group">
            <div class="input-group-prepend">
              <span class="input-group-text" style="background: #f8f9fb; border-right: none;">
                <i class="fa fa-building"></i>
              </span>
            </div>
            <input type="text" 
                   class="form-control" 
                   id="booking-transporter" 
                   placeholder="Start typing to search..."
                   autocomplete="off"
                   required
                   style="border-left: none;">
          </div>
          <div id="transporter-dropdown" class="dropdown-menu" style="width: 100%; max-height: 200px; overflow-y: auto;"></div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label style="font-weight: 600; color: #1e293b;">
                Truck Registration <span style="color: #ef4444;">*</span>
              </label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text" style="background: #f8f9fb; border-right: none;">
                    <i class="fa fa-truck"></i>
                  </span>
                </div>
                <input type="text" 
                       class="form-control" 
                       id="booking-truck-reg" 
                       placeholder="e.g., ABC-123-GP" 
                       required
                       style="border-left: none; text-transform: uppercase;">
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label style="font-weight: 600; color: #1e293b;">Trailer Registration</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text" style="background: #f8f9fb; border-right: none;">
                    <i class="fa fa-trailer"></i>
                  </span>
                </div>
                <input type="text" 
                       class="form-control" 
                       id="booking-trailer-reg"
                       placeholder="e.g., XYZ-456-GP"
                       style="border-left: none; text-transform: uppercase;">
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label style="font-weight: 600; color: #1e293b;">
                Driver Name <span style="color: #ef4444;">*</span>
              </label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text" style="background: #f8f9fb; border-right: none;">
                    <i class="fa fa-user"></i>
                  </span>
                </div>
                <input type="text" 
                       class="form-control" 
                       id="booking-driver-name" 
                       placeholder="Full name"
                       required
                       style="border-left: none;">
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label style="font-weight: 600; color: #1e293b;">
                Driver Contact <span style="color: #ef4444;">*</span>
              </label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text" style="background: #f8f9fb; border-right: none;">
                    <i class="fa fa-phone"></i>
                  </span>
                </div>
                <input type="text" 
                       class="form-control" 
                       id="booking-driver-contact" 
                       placeholder="0771234567" 
                       required
                       style="border-left: none;">
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label style="font-weight: 600; color: #1e293b;">Driver Passport</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text" style="background: #f8f9fb; border-right: none;">
                    <i class="fa fa-id-card"></i>
                  </span>
                </div>
                <input type="text" 
                       class="form-control" 
                       id="booking-driver-passport"
                       placeholder="Passport number"
                       style="border-left: none; text-transform: uppercase;">
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label style="font-weight: 600; color: #1e293b;">Driver Licence</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text" style="background: #f8f9fb; border-right: none;">
                    <i class="fa fa-id-badge"></i>
                  </span>
                </div>
                <input type="text" 
                       class="form-control" 
                       id="booking-driver-licence"
                       placeholder="Licence number"
                       style="border-left: none; text-transform: uppercase;">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="background: #f8f9fb; border-radius: 0 0 12px 12px;">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fa fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-success" id="submit-booking">
          <i class="fa fa-check"></i> Submit Booking
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Update Tracking Modal -->
<div class="modal fade" id="updateTrackingModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style="border-radius: 12px; border: none;">
      <div class="modal-header" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; border-radius: 12px 12px 0 0;">
        <h5 class="modal-title" style="font-weight: 600;">
          <i class="fa fa-route"></i> Update Tracking
        </h5>
        <button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 1;">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body" style="padding: 30px;">
        <input type="hidden" id="tracking-cargo-idx">
        
        <div class="form-group">
          <label style="font-weight: 600; color: #1e293b;">
            Status <span style="color: #ef4444;">*</span>
          </label>
          <select class="form-control" id="tracking-status" required style="padding: 10px; border: 2px solid #e0e6ed; border-radius: 6px;">
            <option value="">Select Status...</option>
            <option value="Loading">ðŸŸ£ Loading</option>
            <option value="In Transit">ðŸŸ  In Transit</option>
            <option value="Offloaded">ðŸŸ¤ Offloaded</option>
            <option value="Delivered">âš« Delivered</option>
          </select>
        </div>
        
        <div class="form-group">
          <label style="font-weight: 600; color: #1e293b;">
            Location <span style="color: #ef4444;">*</span>
          </label>
          <div class="input-group">
            <div class="input-group-prepend">
              <span class="input-group-text" style="background: #f8f9fb; border-right: none;">
                <i class="fa fa-map-marker-alt"></i>
              </span>
            </div>
            <input type="text" 
                   class="form-control" 
                   id="tracking-location" 
                   required 
                   placeholder="e.g., Durban Port, Beitbridge Border"
                   style="border-left: none;">
          </div>
        </div>
        
        <div class="form-group">
          <label style="font-weight: 600; color: #1e293b;">
            Comment <span style="color: #ef4444;">*</span>
          </label>
          <textarea class="form-control" 
                    id="tracking-comment" 
                    rows="4" 
                    required
                    placeholder="Provide details about the current status..."
                    style="border: 2px solid #e0e6ed; border-radius: 6px;"></textarea>
          <small class="form-text text-muted">
            <i class="fa fa-info-circle"></i> Be specific about location, delays, or issues
          </small>
        </div>
      </div>
      <div class="modal-footer" style="background: #f8f9fb; border-radius: 0 0 12px 12px;">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fa fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-primary" id="submit-tracking">
          <i class="fa fa-save"></i> Update
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}
<script>
$(document).ready(function() {
  const doc_name = '{{ doc.name }}';
  let allSuppliers = [];

  // ========================================
  // TOGGLE COLLAPSIBLE DETAILS
  // ========================================
  window.toggleDetails = function(element) {
    const content = $(element).next('.details-content');
    const icon = $(element).find('.toggle-icon');
    
    if (content.hasClass('show')) {
      content.removeClass('show');
      $(element).removeClass('active');
      $(element).find('.toggle-text').html('<i class="fa fa-info-circle"></i> View More Details');
    } else {
      content.addClass('show');
      $(element).addClass('active');
      $(element).find('.toggle-text').html('<i class="fa fa-info-circle"></i> Hide Details');
    }
  };

  // ========================================
  // SEARCH AND FILTER
  // ========================================
  function filterCargo() {
    const searchText = $('#search-input').val().toLowerCase();
    const statusFilter = $('#status-filter').val();
    
    $('.cargo-card').each(function() {
      const $card = $(this);
      const container = $card.data('container').toLowerCase();
      const truck = $card.data('truck').toLowerCase();
      const driver = $card.data('driver').toLowerCase();
      const transporter = $card.data('transporter').toLowerCase();
      const status = $card.data('status');
      
      const matchesSearch = !searchText || 
                           container.includes(searchText) ||
                           truck.includes(searchText) ||
                           driver.includes(searchText) ||
                           transporter.includes(searchText);
      
      const matchesStatus = !statusFilter || status === statusFilter;
      
      if (matchesSearch && matchesStatus) {
        $card.show();
      } else {
        $card.hide();
      }
    });
  }
  
  $('#search-input').on('keyup', filterCargo);
  $('#status-filter').on('change', filterCargo);
  
  window.clearFilters = function() {
    $('#search-input').val('');
    $('#status-filter').val('');
    filterCargo();
  };

  // ========================================
  // LOAD SUPPLIERS FOR TRANSPORTER FIELD
  // ========================================
  function loadSuppliers() {
    frappe.call({
      method: 'frappe.client.get_list',
      args: {
        doctype: 'Supplier',
        filters: { disabled: 0 },
        fields: ['name', 'supplier_name'],
        limit_page_length: 500,
        order_by: 'supplier_name asc'
      },
      callback: (r) => {
        if (r.message) {
          allSuppliers = r.message;
        }
      }
    });
  }

  // Autocomplete for transporter
  $('#booking-transporter').on('focus', function() {
    if (allSuppliers.length === 0) {
      loadSuppliers();
    }
  });

  $('#booking-transporter').on('input', function() {
    const searchTerm = $(this).val().toLowerCase();
    const $dropdown = $('#transporter-dropdown');
    
    if (searchTerm.length < 2) {
      $dropdown.hide();
      return;
    }
    
    const filtered = allSuppliers.filter(s => 
      (s.supplier_name && s.supplier_name.toLowerCase().includes(searchTerm)) ||
      (s.name && s.name.toLowerCase().includes(searchTerm))
    );
    
    if (filtered.length > 0) {
      $dropdown.empty();
      filtered.forEach(supplier => {
        const displayName = supplier.supplier_name || supplier.name;
        $dropdown.append(`
          <a class="dropdown-item" href="#" data-value="${supplier.name}">
            <strong>${displayName}</strong>
            ${supplier.name !== displayName ? '<br><small class="text-muted">' + supplier.name + '</small>' : ''}
          </a>
        `);
      });
      $dropdown.show();
    } else {
      $dropdown.hide();
    }
  });

  $(document).on('click', '#transporter-dropdown .dropdown-item', function(e) {
    e.preventDefault();
    const value = $(this).data('value');
    const displayText = $(this).find('strong').text();
    $('#booking-transporter').val(displayText).data('supplier-id', value);
    $('#transporter-dropdown').hide();
  });

  // Hide dropdown when clicking outside
  $(document).on('click', function(e) {
    if (!$(e.target).closest('#booking-transporter, #transporter-dropdown').length) {
      $('#transporter-dropdown').hide();
    }
  });

  // ========================================
  // ADD BOOKING BUTTON
  // ========================================
  $('.add-booking-btn').click(function() {
    const idx = $(this).data('cargo-idx');
    $('#booking-cargo-idx').val(idx);
    
    // Clear form
    $('#booking-transporter').val('').removeData('supplier-id');
    $('#booking-truck-reg').val('');
    $('#booking-trailer-reg').val('');
    $('#booking-driver-name').val('');
    $('#booking-driver-contact').val('');
    $('#booking-driver-passport').val('');
    $('#booking-driver-licence').val('');
    
    // Load suppliers
    if (allSuppliers.length === 0) {
      loadSuppliers();
    }
    
    $('#addBookingModal').modal('show');
  });

  // ========================================
  // SUBMIT BOOKING
  // ========================================
  $('#submit-booking').click(function() {
    const idx = $('#booking-cargo-idx').val();
    const transporterId = $('#booking-transporter').data('supplier-id');
    const transporterName = $('#booking-transporter').val();
    
    const data = {
      transporter: transporterId || transporterName,
      truck_reg_no: $('#booking-truck-reg').val().toUpperCase(),
      trailer_reg_no: $('#booking-trailer-reg').val().toUpperCase(),
      driver_name: $('#booking-driver-name').val(),
      driver_contact_no: $('#booking-driver-contact').val(),
      driver_passport_no: $('#booking-driver-passport').val().toUpperCase(),
      driver_licence_no: $('#booking-driver-licence').val().toUpperCase()
    };

    if (!data.transporter || !data.truck_reg_no || !data.driver_name || !data.driver_contact_no) {
      frappe.msgprint({
        title: 'Missing Information',
        indicator: 'red',
        message: 'Please fill all required fields marked with *'
      });
      return;
    }

    $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Submitting...');

    frappe.call({
      method: 'freightmas.www.truck_portal.add_truck_booking',
      args: {
        job: doc_name,
        cargo_idx: idx,
        ...data
      },
      callback: (r) => {
        if (r.message && r.message.success) {
          $('#addBookingModal').modal('hide');
          frappe.show_alert({
            message: 'Booking added successfully! ðŸŽ‰',
            indicator: 'green'
          });
          setTimeout(() => location.reload(), 1500);
        }
      },
      error: () => {
        $('#submit-booking').prop('disabled', false).html('<i class="fa fa-check"></i> Submit Booking');
      }
    });
  });

  // ========================================
  // APPROVE BOOKING
  // ========================================
  $('.approve-btn').click(function() {
    const idx = $(this).data('cargo-idx');
    
    frappe.confirm(
      'Are you sure you want to approve this truck booking?',
      () => {
        frappe.call({
          method: 'freightmas.www.truck_portal.approve_booking',
          args: { job: doc_name, cargo_idx: idx },
          callback: (r) => {
            if (r.message && r.message.success) {
              frappe.show_alert({
                message: 'Booking approved âœ“',
                indicator: 'green'
              });
              setTimeout(() => location.reload(), 1000);
            }
          }
        });
      }
    );
  });

  // ========================================
  // REJECT BOOKING
  // ========================================
  $('.reject-btn').click(function() {
    const idx = $(this).data('cargo-idx');
    
    frappe.prompt({
      label: 'Reason for Rejection',
      fieldname: 'reason',
      fieldtype: 'Small Text',
      reqd: 1
    }, (values) => {
      frappe.call({
        method: 'freightmas.www.truck_portal.reject_booking',
        args: { 
          job: doc_name, 
          cargo_idx: idx, 
          reason: values.reason 
        },
        callback: (r) => {
          if (r.message && r.message.success) {
            frappe.show_alert({
              message: 'Booking rejected',
              indicator: 'red'
            });
            setTimeout(() => location.reload(), 1000);
          }
        }
      });
    }, 'Reject Booking', 'Submit');
  });

  // ========================================
  // MARK AS BOOKED
  // ========================================
  $('.book-btn').click(function() {
    const idx = $(this).data('cargo-idx');
    
    frappe.confirm(
      'Mark this truck as booked and ready for loading?',
      () => {
        frappe.call({
          method: 'freightmas.www.truck_portal.mark_booked',
          args: { job: doc_name, cargo_idx: idx },
          callback: (r) => {
            if (r.message && r.message.success) {
              frappe.show_alert({
                message: 'Marked as booked âœ“',
                indicator: 'blue'
              });
              setTimeout(() => location.reload(), 1000);
            }
          }
        });
      }
    );
  });

  // ========================================
  // UPDATE TRACKING
  // ========================================
  $('.update-tracking-btn').click(function() {
    const idx = $(this).data('cargo-idx');
    $('#tracking-cargo-idx').val(idx);
    
    // Clear form
    $('#tracking-status').val('');
    $('#tracking-location').val('');
    $('#tracking-comment').val('');
    
    $('#updateTrackingModal').modal('show');
  });

  $('#submit-tracking').click(function() {
    const idx = $('#tracking-cargo-idx').val();
    const data = {
      status: $('#tracking-status').val(),
      location: $('#tracking-location').val(),
      comment: $('#tracking-comment').val()
    };

    if (!data.status || !data.location || !data.comment) {
      frappe.msgprint({
        title: 'Missing Information',
        indicator: 'red',
        message: 'Please fill all fields'
      });
      return;
    }

    $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Updating...');

    frappe.call({
      method: 'freightmas.www.truck_portal.update_tracking',
      args: {
        job: doc_name,
        cargo_idx: idx,
        ...data
      },
      callback: (r) => {
        if (r.message && r.message.success) {
          $('#updateTrackingModal').modal('hide');
          frappe.show_alert({
            message: 'Tracking updated âœ“',
            indicator: 'green'
          });
          setTimeout(() => location.reload(), 1500);
        }
      },
      error: () => {
        $('#submit-tracking').prop('disabled', false).html('<i class="fa fa-save"></i> Update');
      }
    });
  });

  // Auto-uppercase for reg numbers
  $('#booking-truck-reg, #booking-trailer-reg, #booking-driver-passport, #booking-driver-licence').on('input', function() {
    this.value = this.value.toUpperCase();
  });
});
</script>
{% endblock %}