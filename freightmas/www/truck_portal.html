{% extends "templates/web.html" %}

{% block title %}{{ doc.name }} - Truck Portal{% endblock %}

{% block page_content %}
<style>
  /* ============================
     Dark Theme - Compact Desktop UI
     ============================ */
  :root {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #21262d;
    --bg-hover: #30363d;
    --border-color: #30363d;
    --border-light: #21262d;
    --text-primary: #e6edf3;
    --text-secondary: #8b949e;
    --text-muted: #6e7681;
    --accent-purple: #8b5cf6;
    --accent-purple-dark: #7c3aed;
    --accent-blue: #58a6ff;
    --accent-green: #3fb950;
    --accent-yellow: #d29922;
    --accent-red: #f85149;
    --accent-orange: #db6d28;
  }

  html, body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 13px;
    line-height: 1.4;
  }

  .page-header-actions-block, .page-head-content, .standard-sidebar,
  nav.navbar, footer, .web-footer, .footer-powered, .page-footer {
    display: none !important;
  }

  .container-fluid { padding: 0 !important; margin: 0 !important; max-width: none !important; }

  /* Back Button */
  .back-btn {
    position: fixed;
    top: 12px;
    right: 16px;
    background: var(--accent-purple);
    color: #fff;
    padding: 6px 14px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    font-size: 12px;
    z-index: 1000;
    transition: all 0.2s;
  }
  .back-btn:hover { background: var(--accent-purple-dark); transform: translateY(-1px); }

  /* Main Container */
  .portal-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 12px 16px 24px;
  }

  /* Header */
  .portal-header {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
  }

  .job-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
  }

  .job-ref {
    font-size: 12px;
    color: var(--text-secondary);
    margin-left: 10px;
  }

  .job-meta {
    display: flex;
    gap: 20px;
    font-size: 12px;
    color: var(--text-secondary);
  }

  .job-meta-item span:first-child {
    color: var(--text-muted);
    margin-right: 4px;
  }

  /* Stats Bar */
  .stats-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }

  .stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px 16px;
    min-width: 100px;
    text-align: center;
  }

  .stat-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-primary);
  }

  .stat-label {
    font-size: 10px;
    text-transform: uppercase;
    color: var(--text-muted);
    letter-spacing: 0.5px;
  }

  .stat-card.completed .stat-value { color: var(--accent-green); }
  .stat-card.pending .stat-value { color: var(--accent-yellow); }
  .stat-card.in-transit .stat-value { color: var(--accent-blue); }

  /* Toolbar */
  .toolbar {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px 12px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .toolbar-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .toolbar-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .search-input {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 7px 12px;
    color: var(--text-primary);
    font-size: 12px;
    width: 260px;
    transition: border-color 0.2s;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--accent-purple);
  }

  .search-input::placeholder { color: var(--text-muted); }

  .filter-select {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 7px 28px 7px 10px;
    color: var(--text-primary);
    font-size: 12px;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238b949e' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
  }

  .filter-select:focus { outline: none; border-color: var(--accent-purple); }

  .btn {
    padding: 7px 14px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }

  .btn-primary {
    background: var(--accent-purple);
    color: #fff;
  }
  .btn-primary:hover { background: var(--accent-purple-dark); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

  .btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border-color);
  }
  .btn-secondary:hover { background: var(--bg-hover); }

  .btn-success {
    background: var(--accent-green);
    color: #fff;
  }
  .btn-success:hover { background: #2ea043; }

  .btn-sm {
    padding: 4px 10px;
    font-size: 11px;
  }

  .btn-icon {
    padding: 6px 8px;
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-icon:hover { background: var(--bg-hover); color: var(--text-primary); }

  /* Checkbox */
  .checkbox-wrap {
    display: flex;
    align-items: center;
  }

  .cargo-checkbox {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--accent-purple);
  }

  /* Main Table */
  .cargo-table {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
  }

  .table-header {
    display: grid;
    grid-template-columns: 40px 2fr 1.2fr 1fr 1.5fr 2fr 160px 100px;
    gap: 8px;
    padding: 10px 12px;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-color);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    align-items: center;
  }

  .cargo-row {
    display: grid;
    grid-template-columns: 40px 2fr 1.2fr 1fr 1.5fr 2fr 160px 100px;
    gap: 8px;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-light);
    align-items: center;
    transition: background 0.15s;
  }

  .cargo-row:hover { background: var(--bg-tertiary); }
  .cargo-row:last-child { border-bottom: none; }

  .cargo-row.selected { background: rgba(139, 92, 246, 0.1); }

  .cargo-id {
    font-weight: 600;
    color: var(--text-primary);
  }

  .cargo-sub {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .truck-info {
    font-size: 12px;
    color: var(--text-primary);
  }

  .truck-sub {
    font-size: 11px;
    color: var(--text-muted);
  }

  .driver-info {
    font-size: 12px;
    color: var(--text-primary);
  }

  .driver-contact {
    font-size: 10px;
    color: var(--text-muted);
  }

  /* Inline Input */
  .inline-input {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 5px 8px;
    color: var(--text-primary);
    font-size: 11px;
    width: 100%;
    transition: border-color 0.2s;
  }

  .inline-input:focus {
    outline: none;
    border-color: var(--accent-purple);
  }

  .inline-input::placeholder { color: var(--text-muted); }

  .location-cell {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  /* Milestone Pills */
  .milestone-pills {
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .milestone-pill {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid var(--border-color);
    background: transparent;
    color: var(--text-muted);
    position: relative;
  }

  .milestone-pill.completed {
    background: var(--accent-green);
    border-color: var(--accent-green);
    color: #fff;
  }

  .milestone-pill.next {
    border-color: var(--accent-blue);
    color: var(--accent-blue);
    animation: pulse-border 2s infinite;
  }

  .milestone-pill:hover:not(.completed) {
    border-color: var(--accent-purple);
    color: var(--accent-purple);
    transform: scale(1.1);
  }

  .milestone-pill[title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-primary);
    color: var(--text-primary);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    white-space: nowrap;
    z-index: 100;
    margin-bottom: 4px;
    border: 1px solid var(--border-color);
  }

  @keyframes pulse-border {
    0%, 100% { box-shadow: 0 0 0 0 rgba(88, 166, 255, 0.4); }
    50% { box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.1); }
  }

  /* Status Badge */
  .status-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .status-draft { background: var(--bg-tertiary); color: var(--text-muted); }
  .status-pending { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }
  .status-loading { background: rgba(88, 166, 255, 0.2); color: var(--accent-blue); }
  .status-in-transit { background: rgba(210, 153, 34, 0.2); color: var(--accent-yellow); }
  .status-completed { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }

  /* Row Actions */
  .row-actions {
    display: flex;
    gap: 4px;
    justify-content: flex-end;
  }

  /* Extended Tracking Row */
  .extended-row {
    display: none;
    grid-column: 1 / -1;
    background: var(--bg-primary);
    padding: 12px 16px;
    margin: 0 12px 8px;
    border-radius: 6px;
    border: 1px solid var(--border-light);
  }

  .extended-row.show { display: block; }

  .extended-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }

  .extended-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .extended-label {
    font-size: 10px;
    text-transform: uppercase;
    color: var(--text-muted);
    font-weight: 600;
  }

  .extended-value {
    font-size: 12px;
    color: var(--text-primary);
  }

  .extended-input {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 6px 10px;
    color: var(--text-primary);
    font-size: 12px;
    width: 100%;
  }

  .extended-input:focus { outline: none; border-color: var(--accent-purple); }

  .extended-actions {
    margin-top: 12px;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.75);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }

  .modal-overlay.show { display: flex; }

  .modal-box {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    width: 100%;
    max-width: 480px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }

  .modal-header {
    background: var(--accent-purple);
    padding: 10px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-title {
    font-size: 13px;
    font-weight: 700;
    color: #fff;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .modal-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
    padding: 2px 8px;
    line-height: 1;
    border-radius: 4px;
  }

  .modal-close:hover { background: rgba(255,255,255,0.3); }

  .modal-body {
    padding: 12px 14px;
  }

  .modal-footer {
    padding: 10px 14px;
    background: var(--bg-tertiary);
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }

  /* Fetch Truck Section */
  .fetch-truck-section {
    background: var(--bg-tertiary);
    border: 1px dashed var(--border-color);
    border-radius: 6px;
    padding: 10px 12px;
    margin-bottom: 12px;
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }

  .fetch-truck-section .form-group {
    flex: 1;
    margin: 0;
  }

  .fetch-truck-section .form-label {
    font-size: 10px;
    margin-bottom: 4px;
  }

  .fetch-truck-section .form-input {
    padding: 6px 10px;
    font-size: 12px;
  }

  .btn-fetch {
    background: var(--accent-blue);
    color: #fff;
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
  }

  .btn-fetch:hover { background: #4c9aed; }

  .or-divider {
    text-align: center;
    color: var(--text-muted);
    font-size: 10px;
    margin-bottom: 10px;
    position: relative;
  }

  .or-divider::before,
  .or-divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 40%;
    height: 1px;
    background: var(--border-color);
  }

  .or-divider::before { left: 0; }
  .or-divider::after { right: 0; }

  /* Form - Compact */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .form-group.full { grid-column: 1 / -1; }
  .form-group.span-3 { grid-column: span 1; }

  .form-label {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .form-label .required { color: var(--accent-red); }

  .form-input {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 7px 10px;
    color: var(--text-primary);
    font-size: 13px;
    transition: border-color 0.2s;
  }

  .form-input:focus { outline: none; border-color: var(--accent-purple); }
  .form-input::placeholder { color: var(--text-muted); }

  /* Supplier Dropdown */
  .supplier-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    margin-top: 4px;
  }

  .supplier-dropdown.show { display: block; }

  .supplier-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-light);
  }

  .supplier-item:hover { background: var(--bg-tertiary); }
  .supplier-item:last-child { border-bottom: none; }

  .supplier-name { font-weight: 600; color: var(--text-primary); }
  .supplier-code { font-size: 11px; color: var(--text-muted); }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 13px;
    z-index: 20000;
    animation: slideIn 0.3s ease;
  }

  .toast.success { background: var(--accent-green); color: #fff; }
  .toast.error { background: var(--accent-red); color: #fff; }

  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Bulk Action Bar */
  .bulk-action-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    padding: 12px 20px;
    display: none;
    align-items: center;
    justify-content: space-between;
    z-index: 500;
  }

  .bulk-action-bar.show { display: flex; }

  .bulk-info {
    font-size: 13px;
    color: var(--text-primary);
  }

  .bulk-info strong { color: var(--accent-purple); }

  .bulk-actions {
    display: flex;
    gap: 8px;
  }

  /* Expand Toggle */
  .expand-toggle {
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    font-size: 10px;
    transition: color 0.2s;
  }

  .expand-toggle:hover { color: var(--accent-purple); }
  .expand-toggle.expanded { color: var(--accent-purple); }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
  }

  .empty-state i { font-size: 40px; margin-bottom: 12px; }

  /* Spinner */
  .spinner {
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: inline-block;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* No Truck Assigned */
  .no-truck {
    color: var(--text-muted);
    font-style: italic;
    font-size: 11px;
  }

  .assign-link {
    color: var(--accent-purple);
    text-decoration: none;
    cursor: pointer;
    font-size: 11px;
  }

  .assign-link:hover { text-decoration: underline; }
</style>

<a class="back-btn" href="/app">‚Üê Back to Desk</a>

<div class="portal-container">
  <!-- Header -->
  <div class="portal-header">
    <div style="display: flex; align-items: baseline; gap: 8px;">
      <h1 class="job-title">{{ doc.name }}</h1>
      {% if doc.customer_reference %}
        <span class="job-ref">Ref: {{ doc.customer_reference }}</span>
      {% endif %}
    </div>
    <div class="job-meta">
      <div class="job-meta-item"><span>Customer:</span> {{ doc.customer_name or doc.customer }}</div>
      <div class="job-meta-item"><span>Direction:</span> {{ doc.direction or "N/A" }}</div>
      <div class="job-meta-item"><span>Cargo:</span> {{ doc.cargo_description or "N/A" }}</div>
      <div class="job-meta-item"><span>Date:</span> {{ doc.date_created.strftime('%d-%b-%y') if doc.date_created else 'N/A' }}</div>
    </div>
  </div>

  <!-- Stats Bar -->
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-value">{{ total_cargo }}</div>
      <div class="stat-label">Total Cargo</div>
    </div>
    <div class="stat-card completed">
      <div class="stat-value">{{ completed_cargo }}</div>
      <div class="stat-label">Completed</div>
    </div>
    <div class="stat-card in-transit">
      <div class="stat-value">{{ doc.cargo_parcel_details | selectattr('is_loaded') | rejectattr('is_completed') | list | length }}</div>
      <div class="stat-label">In Transit</div>
    </div>
    <div class="stat-card pending">
      <div class="stat-value">{{ pending_cargo }}</div>
      <div class="stat-label">Pending</div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-left">
      <input type="text" class="search-input" id="searchInput" placeholder="Search container, truck, driver...">
      <select class="filter-select" id="statusFilter">
        <option value="">All Status</option>
        <option value="draft">Draft</option>
        <option value="pending">Pending</option>
        <option value="loading">Loading</option>
        <option value="in-transit">In Transit</option>
        <option value="completed">Completed</option>
      </select>
      <button class="btn btn-secondary btn-sm" onclick="clearFilters()">Clear</button>
    </div>
    <div class="toolbar-right">
      <button class="btn btn-secondary btn-sm" onclick="toggleSelectAll()">
        <i class="fa fa-check-square-o"></i> Select All
      </button>
      <button class="btn btn-secondary btn-sm" onclick="expandAll()">
        <i class="fa fa-expand"></i> Expand All
      </button>
      <button class="btn btn-secondary btn-sm" onclick="collapseAll()">
        <i class="fa fa-compress"></i> Collapse All
      </button>
    </div>
  </div>

  <!-- Main Table -->
  <div class="cargo-table">
    <div class="table-header">
      <div><input type="checkbox" class="cargo-checkbox" id="selectAllCheckbox" onchange="handleSelectAll(this)"></div>
      <div>Cargo</div>
      <div>Truck</div>
      <div>Driver</div>
      <div>Location / Comment</div>
      <div>Milestones</div>
      <div>Status</div>
      <div style="text-align: right;">Actions</div>
    </div>

    {% for cargo in doc.cargo_parcel_details %}
    {% set cargo_status %}
      {% if cargo.is_completed %}completed
      {% elif cargo.is_offloaded or cargo.is_loaded %}in-transit
      {% elif cargo.is_booked %}loading
      {% elif cargo.truck_reg_no %}pending
      {% else %}draft
      {% endif %}
    {% endset %}
    {% set next_milestone %}
      {% if not cargo.is_booked and cargo.truck_reg_no %}booked
      {% elif cargo.is_booked and not cargo.is_loaded %}loaded
      {% elif cargo.is_loaded and not cargo.is_offloaded %}offloaded
      {% elif cargo.is_offloaded and cargo.to_be_returned and not cargo.is_returned %}returned
      {% elif (cargo.is_offloaded and not cargo.to_be_returned) or (cargo.is_returned and cargo.to_be_returned) %}completed
      {% else %}none
      {% endif %}
    {% endset %}

    <div class="cargo-row"
         data-idx="{{ loop.index0 }}"
         data-status="{{ cargo_status.strip() }}"
         data-search="{{ (cargo.container_number or cargo.cargo_item_description or '') | lower }} {{ (cargo.transporter or '') | lower }} {{ (cargo.truck_reg_no or '') | lower }} {{ (cargo.driver_name or '') | lower }}"
         data-has-extended="{{ '1' if (cargo.border_tracking or cargo.border_2_tracking or cargo.offloading_point) else '0' }}">
      
      <div class="checkbox-wrap">
        <input type="checkbox" class="cargo-checkbox row-checkbox" data-idx="{{ loop.index0 }}">
      </div>

      <div>
        <div class="cargo-id">
          {% if cargo.container_number %}{{ cargo.container_number }}
          {% else %}{{ cargo.cargo_item_description or ("Cargo " ~ loop.index) }}{% endif %}
        </div>
        <div class="cargo-sub">{{ cargo.container_type or (cargo.cargo_quantity|string ~ " " ~ (cargo.cargo_uom or "pcs")) }}</div>
      </div>

      <div>
        {% if cargo.truck_reg_no %}
          <div class="truck-info">{{ cargo.truck_reg_no }}</div>
          <div class="truck-sub">{{ cargo.transporter or "-" }}</div>
        {% else %}
          <span class="no-truck">No truck</span>
          <a class="assign-link" onclick="openTruckModal({{ loop.index0 }})">+ Assign</a>
        {% endif %}
      </div>

      <div>
        {% if cargo.driver_name %}
          <div class="driver-info">{{ cargo.driver_name }}</div>
          <div class="driver-contact">{{ cargo.driver_contact_no or "" }}</div>
        {% else %}
          <span class="no-truck">-</span>
        {% endif %}
      </div>

      <div class="location-cell">
        <input type="text" class="inline-input location-input" 
               data-idx="{{ loop.index0 }}"
               value="{{ cargo.truck_location or '' }}"
               placeholder="Enter location..."
               onchange="saveInlineLocation({{ loop.index0 }})">
        <input type="text" class="inline-input comment-input" 
               data-idx="{{ loop.index0 }}"
               value="{{ cargo.tracking_comment or '' }}"
               placeholder="Comment..."
               onchange="saveInlineComment({{ loop.index0 }})">
      </div>

      <div class="milestone-pills">
        <div class="milestone-pill {{ 'completed' if cargo.is_booked else ('next' if next_milestone.strip() == 'booked' else '') }}"
             title="Booked{{ ': ' ~ cargo.booked_on_date.strftime('%d-%b') if cargo.booked_on_date else '' }}"
             onclick="quickMilestone({{ loop.index0 }}, 'booked', {{ 'true' if cargo.is_booked else 'false' }})">
          {% if cargo.is_booked %}<i class="fa fa-check"></i>{% else %}B{% endif %}
        </div>
        <div class="milestone-pill {{ 'completed' if cargo.is_loaded else ('next' if next_milestone.strip() == 'loaded' else '') }}"
             title="Loaded{{ ': ' ~ cargo.loaded_on_date.strftime('%d-%b') if cargo.loaded_on_date else '' }}"
             onclick="quickMilestone({{ loop.index0 }}, 'loaded', {{ 'true' if cargo.is_loaded else 'false' }})">
          {% if cargo.is_loaded %}<i class="fa fa-check"></i>{% else %}L{% endif %}
        </div>
        <div class="milestone-pill {{ 'completed' if cargo.is_offloaded else ('next' if next_milestone.strip() == 'offloaded' else '') }}"
             title="Offloaded{{ ': ' ~ cargo.offloaded_on_date.strftime('%d-%b') if cargo.offloaded_on_date else '' }}"
             onclick="quickMilestone({{ loop.index0 }}, 'offloaded', {{ 'true' if cargo.is_offloaded else 'false' }})">
          {% if cargo.is_offloaded %}<i class="fa fa-check"></i>{% else %}O{% endif %}
        </div>
        {% if cargo.to_be_returned %}
        <div class="milestone-pill {{ 'completed' if cargo.is_returned else ('next' if next_milestone.strip() == 'returned' else '') }}"
             title="Returned{{ ': ' ~ cargo.returned_on_date.strftime('%d-%b') if cargo.returned_on_date else '' }}"
             onclick="quickMilestone({{ loop.index0 }}, 'returned', {{ 'true' if cargo.is_returned else 'false' }})">
          {% if cargo.is_returned %}<i class="fa fa-check"></i>{% else %}R{% endif %}
        </div>
        {% endif %}
        <div class="milestone-pill {{ 'completed' if cargo.is_completed else ('next' if next_milestone.strip() == 'completed' else '') }}"
             title="Completed{{ ': ' ~ cargo.completed_on_date.strftime('%d-%b') if cargo.completed_on_date else '' }}"
             onclick="quickMilestone({{ loop.index0 }}, 'completed', {{ 'true' if cargo.is_completed else 'false' }})">
          {% if cargo.is_completed %}<i class="fa fa-check"></i>{% else %}C{% endif %}
        </div>
      </div>

      <div>
        <span class="status-badge status-{{ cargo_status.strip() }}">{{ cargo_status.strip().replace('-', ' ') }}</span>
      </div>

      <div class="row-actions">
        {% if cargo.border_tracking or cargo.border_2_tracking or cargo.offloading_point %}
        <button class="btn-icon expand-toggle" onclick="toggleExtended({{ loop.index0 }})" title="Extended Tracking">
          <i class="fa fa-road"></i>
        </button>
        {% endif %}
        <button class="btn-icon" onclick="openTruckModal({{ loop.index0 }})" title="Edit Truck Details">
          <i class="fa fa-truck"></i>
        </button>
      </div>
    </div>

    <!-- Extended Tracking Row -->
    {% if cargo.border_tracking or cargo.border_2_tracking or cargo.offloading_point %}
    <div class="extended-row" id="extended-{{ loop.index0 }}" data-idx="{{ loop.index0 }}">
      <div class="extended-grid">
        {% if cargo.border_tracking %}
        <div class="extended-item">
          <div class="extended-label">Border 1: {{ cargo.border_name or "Border" }}</div>
          <div style="display: flex; gap: 8px;">
            <div style="flex: 1;">
              <div style="font-size: 10px; color: var(--text-muted);">Arrived</div>
              <input type="datetime-local" class="extended-input" 
                     id="border1_arrived_{{ loop.index0 }}"
                     value="{{ cargo.border_arrived_on.strftime('%Y-%m-%dT%H:%M') if cargo.border_arrived_on else '' }}">
            </div>
            <div style="flex: 1;">
              <div style="font-size: 10px; color: var(--text-muted);">Left</div>
              <input type="datetime-local" class="extended-input"
                     id="border1_left_{{ loop.index0 }}"
                     value="{{ cargo.border_left_on.strftime('%Y-%m-%dT%H:%M') if cargo.border_left_on else '' }}">
            </div>
          </div>
        </div>
        {% endif %}
        
        {% if cargo.border_2_tracking %}
        <div class="extended-item">
          <div class="extended-label">Border 2: {{ cargo.border_2_name or "Border" }}</div>
          <div style="display: flex; gap: 8px;">
            <div style="flex: 1;">
              <div style="font-size: 10px; color: var(--text-muted);">Arrived</div>
              <input type="datetime-local" class="extended-input"
                     id="border2_arrived_{{ loop.index0 }}"
                     value="{{ cargo.border_2_arrived_on.strftime('%Y-%m-%dT%H:%M') if cargo.border_2_arrived_on else '' }}">
            </div>
            <div style="flex: 1;">
              <div style="font-size: 10px; color: var(--text-muted);">Left</div>
              <input type="datetime-local" class="extended-input"
                     id="border2_left_{{ loop.index0 }}"
                     value="{{ cargo.border_2_left_on.strftime('%Y-%m-%dT%H:%M') if cargo.border_2_left_on else '' }}">
            </div>
          </div>
        </div>
        {% endif %}
        
        {% if cargo.offloading_point %}
        <div class="extended-item">
          <div class="extended-label">Offloading Point</div>
          <div style="font-size: 10px; color: var(--text-muted);">Arrived</div>
          <input type="datetime-local" class="extended-input"
                 id="offloading_arrived_{{ loop.index0 }}"
                 value="{{ cargo.offloading_arrived_on.strftime('%Y-%m-%dT%H:%M') if cargo.offloading_arrived_on else '' }}">
        </div>
        {% endif %}
      </div>
      <div class="extended-actions">
        <button class="btn btn-primary btn-sm" onclick="saveExtendedTracking({{ loop.index0 }})">
          Save Extended Tracking
        </button>
      </div>
    </div>
    {% endif %}

    {% endfor %}

    {% if not doc.cargo_parcel_details %}
    <div class="empty-state">
      <i class="fa fa-box-open"></i>
      <p>No cargo items found</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Bulk Action Bar -->
<div class="bulk-action-bar" id="bulkActionBar">
  <div class="bulk-info">
    <strong id="selectedCount">0</strong> items selected
  </div>
  <div class="bulk-actions">
    <button class="btn btn-secondary btn-sm" onclick="clearSelection()">Clear</button>
    <button class="btn btn-success btn-sm" onclick="bulkMilestone('booked')">Mark Booked</button>
    <button class="btn btn-success btn-sm" onclick="bulkMilestone('loaded')">Mark Loaded</button>
    <button class="btn btn-success btn-sm" onclick="bulkMilestone('offloaded')">Mark Offloaded</button>
    <button class="btn btn-success btn-sm" onclick="bulkMilestone('completed')">Mark Completed</button>
  </div>
</div>

<!-- Truck Details Modal -->
<div class="modal-overlay" id="truckModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3 class="modal-title"><i class="fa fa-truck"></i> Truck Assignment</h3>
      <button class="modal-close" onclick="closeTruckModal()">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Fetch from Truck -->
      <div class="fetch-truck-section">
        <div class="form-group" style="position: relative;">
          <label class="form-label">Quick Load from Truck</label>
          <input type="text" class="form-input" id="fetchTruckInput" placeholder="Search truck reg..." autocomplete="off">
          <div class="supplier-dropdown" id="truckDropdown"></div>
        </div>
        <button type="button" class="btn-fetch" onclick="fetchFromTruck()">
          <i class="fa fa-download"></i> Fetch
        </button>
      </div>
      
      <div class="or-divider">OR ENTER MANUALLY</div>
      
      <form id="truckForm" onsubmit="saveTruckDetails(event)">
        <div class="form-grid">
          <div class="form-group full" style="position: relative;">
            <label class="form-label">Transporter <span class="required">*</span></label>
            <input type="text" class="form-input" id="transporterInput" placeholder="Search transporter..." autocomplete="off">
            <div class="supplier-dropdown" id="supplierDropdown"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Truck Reg <span class="required">*</span></label>
            <input type="text" class="form-input" id="truckRegInput" placeholder="Enter truck reg" style="text-transform: uppercase;">
          </div>
          <div class="form-group">
            <label class="form-label">Trailer Reg</label>
            <input type="text" class="form-input" id="trailerRegInput" placeholder="Enter trailer reg" style="text-transform: uppercase;">
          </div>
          <div class="form-group">
            <label class="form-label">Driver <span class="required">*</span></label>
            <input type="text" class="form-input" id="driverNameInput" placeholder="Enter driver name">
          </div>
          <div class="form-group">
            <label class="form-label">Contact 1 <span class="required">*</span></label>
            <input type="tel" class="form-input" id="contact1Input" placeholder="Enter phone number">
          </div>
          <div class="form-group">
            <label class="form-label">Contact 2</label>
            <input type="tel" class="form-input" id="contact2Input" placeholder="Enter alt. number">
          </div>
          <div class="form-group">
            <label class="form-label">Passport</label>
            <input type="text" class="form-input" id="passportInput" placeholder="Enter passport no." style="text-transform: uppercase;">
          </div>
          <div class="form-group full">
            <label class="form-label">Licence No</label>
            <input type="text" class="form-input" id="licenceInput" placeholder="Enter licence no." style="text-transform: uppercase;">
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeTruckModal()">Cancel</button>
      <button class="btn btn-primary" id="saveTruckBtn" onclick="saveTruckDetails(event)">
        <span class="spinner" style="display: none;" id="truckSpinner"></span>
        Save
      </button>
    </div>
  </div>
</div>

<!-- Milestone Comment Modal -->
<div class="modal-overlay" id="milestoneModal">
  <div class="modal-box" style="max-width: 400px;">
    <div class="modal-header">
      <h3 class="modal-title" id="milestoneTitle">Update Milestone</h3>
      <button class="modal-close" onclick="closeMilestoneModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Comment (Optional)</label>
        <textarea class="form-input" id="milestoneComment" rows="3" placeholder="Add a comment..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeMilestoneModal()">Cancel</button>
      <button class="btn btn-success" onclick="confirmMilestone()">Confirm</button>
    </div>
  </div>
</div>

<script>
const jobName = '{{ doc.name }}';
let currentCargoIdx = null;
let allSuppliers = [];
let pendingMilestone = null;
let pendingMilestoneIdx = null;
let pendingBulkMilestone = null;

// ========================================
// INITIALIZATION
// ========================================
frappe.ready(function() {
  setupFilters();
  setupSupplierSearch();
  setupTruckSearch();
  setupCheckboxListeners();
  
  // Override frappe's default error handler to use toast
  if (frappe.request) {
    const originalErrorHandler = frappe.request.error_handlers[''] || function(){};
    frappe.request.error_handlers[''] = function(xhr) {
      // Don't show default dialog, just toast
      try {
        const response = JSON.parse(xhr.responseText);
        if (response._server_messages) {
          const msgs = JSON.parse(response._server_messages);
          msgs.forEach(m => {
            const msg = JSON.parse(m);
            showToast(msg.message || 'An error occurred', 'error');
          });
        } else if (response.exc_type) {
          showToast(response.exc_type + ': Check permissions', 'error');
        } else {
          showToast('An error occurred', 'error');
        }
      } catch(e) {
        showToast('An error occurred', 'error');
      }
    };
  }
});

// ========================================
// FILTERS
// ========================================
function setupFilters() {
  document.getElementById('searchInput').addEventListener('input', applyFilters);
  document.getElementById('statusFilter').addEventListener('change', applyFilters);
}

function applyFilters() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const status = document.getElementById('statusFilter').value;
  
  document.querySelectorAll('.cargo-row').forEach(row => {
    const matchSearch = !search || row.dataset.search.includes(search);
    const matchStatus = !status || row.dataset.status === status;
    row.style.display = (matchSearch && matchStatus) ? '' : 'none';
    
    // Also hide extended row if parent is hidden
    const extRow = document.getElementById('extended-' + row.dataset.idx);
    if (extRow && row.style.display === 'none') {
      extRow.classList.remove('show');
    }
  });
}

function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('statusFilter').value = '';
  applyFilters();
}

// ========================================
// SELECTION & BULK ACTIONS
// ========================================
function setupCheckboxListeners() {
  document.querySelectorAll('.row-checkbox').forEach(cb => {
    cb.addEventListener('change', updateBulkBar);
  });
}

function updateBulkBar() {
  const selected = document.querySelectorAll('.row-checkbox:checked').length;
  const bar = document.getElementById('bulkActionBar');
  document.getElementById('selectedCount').textContent = selected;
  bar.classList.toggle('show', selected > 0);
  
  // Update row highlighting
  document.querySelectorAll('.cargo-row').forEach(row => {
    const cb = row.querySelector('.row-checkbox');
    row.classList.toggle('selected', cb && cb.checked);
  });
}

function handleSelectAll(cb) {
  document.querySelectorAll('.row-checkbox').forEach(checkbox => {
    if (checkbox.closest('.cargo-row').style.display !== 'none') {
      checkbox.checked = cb.checked;
    }
  });
  updateBulkBar();
}

function toggleSelectAll() {
  const checkboxes = document.querySelectorAll('.row-checkbox');
  const allChecked = Array.from(checkboxes).every(cb => cb.checked);
  checkboxes.forEach(cb => { cb.checked = !allChecked; });
  document.getElementById('selectAllCheckbox').checked = !allChecked;
  updateBulkBar();
}

function clearSelection() {
  document.querySelectorAll('.row-checkbox').forEach(cb => { cb.checked = false; });
  document.getElementById('selectAllCheckbox').checked = false;
  updateBulkBar();
}

// ========================================
// BULK MILESTONE
// ========================================
function bulkMilestone(milestone) {
  const selectedIdxs = Array.from(document.querySelectorAll('.row-checkbox:checked'))
    .map(cb => parseInt(cb.dataset.idx));
  
  if (selectedIdxs.length === 0) {
    showToast('No items selected', 'error');
    return;
  }
  
  pendingBulkMilestone = { milestone, indices: selectedIdxs };
  document.getElementById('milestoneTitle').textContent = `Mark ${selectedIdxs.length} items as ${milestone}`;
  document.getElementById('milestoneComment').value = '';
  document.getElementById('milestoneModal').classList.add('show');
}

// ========================================
// INLINE LOCATION/COMMENT SAVE
// ========================================
function saveInlineLocation(idx) {
  const input = document.querySelector(`.location-input[data-idx="${idx}"]`);
  const location = input.value.trim();
  
  frappe.call({
    method: 'freightmas.www.truck_portal.update_tracking',
    args: { job: jobName, cargo_idx: idx, truck_location: location },
    callback: (r) => {
      if (r.message && r.message.success) {
        showToast('Location saved', 'success');
      }
    },
    error: () => showToast('Failed to save', 'error')
  });
}

function saveInlineComment(idx) {
  const input = document.querySelector(`.comment-input[data-idx="${idx}"]`);
  const comment = input.value.trim();
  
  frappe.call({
    method: 'freightmas.www.truck_portal.update_tracking',
    args: { job: jobName, cargo_idx: idx, comment: comment },
    callback: (r) => {
      if (r.message && r.message.success) {
        showToast('Comment saved', 'success');
      }
    },
    error: () => showToast('Failed to save', 'error')
  });
}

// ========================================
// QUICK MILESTONE
// ========================================
function quickMilestone(idx, milestone, isCompleted) {
  if (isCompleted) return; // Already done
  
  pendingMilestoneIdx = idx;
  pendingMilestone = milestone;
  pendingBulkMilestone = null;
  
  document.getElementById('milestoneTitle').textContent = `Mark as ${milestone.charAt(0).toUpperCase() + milestone.slice(1)}`;
  document.getElementById('milestoneComment').value = '';
  document.getElementById('milestoneModal').classList.add('show');
}

function closeMilestoneModal() {
  document.getElementById('milestoneModal').classList.remove('show');
  pendingMilestone = null;
  pendingMilestoneIdx = null;
  pendingBulkMilestone = null;
}

function confirmMilestone() {
  const comment = document.getElementById('milestoneComment').value.trim();
  
  if (pendingBulkMilestone) {
    // Bulk update
    const { milestone, indices } = pendingBulkMilestone;
    let completed = 0;
    
    indices.forEach(idx => {
      frappe.call({
        method: 'freightmas.www.truck_portal.update_milestone',
        args: {
          job: jobName,
          cargo_idx: idx,
          milestone: milestone,
          date: new Date().toISOString().split('T')[0],
          comment: comment
        },
        async: false,
        callback: () => { completed++; }
      });
    });
    
    showToast(`Updated ${completed} items`, 'success');
    closeMilestoneModal();
    clearSelection();
    setTimeout(() => location.reload(), 800);
    
  } else if (pendingMilestone && pendingMilestoneIdx !== null) {
    // Single update
    frappe.call({
      method: 'freightmas.www.truck_portal.update_milestone',
      args: {
        job: jobName,
        cargo_idx: pendingMilestoneIdx,
        milestone: pendingMilestone,
        date: new Date().toISOString().split('T')[0],
        comment: comment
      },
      callback: (r) => {
        if (r.message && r.message.success) {
          showToast('Milestone updated', 'success');
          closeMilestoneModal();
          setTimeout(() => location.reload(), 800);
        }
      },
      error: () => showToast('Failed to update', 'error')
    });
  }
}

// ========================================
// EXTENDED TRACKING
// ========================================
function toggleExtended(idx) {
  const row = document.getElementById('extended-' + idx);
  const btn = document.querySelector(`.cargo-row[data-idx="${idx}"] .expand-toggle`);
  if (row) {
    row.classList.toggle('show');
    btn.classList.toggle('expanded', row.classList.contains('show'));
  }
}

function expandAll() {
  document.querySelectorAll('.extended-row').forEach(row => row.classList.add('show'));
  document.querySelectorAll('.expand-toggle').forEach(btn => btn.classList.add('expanded'));
}

function collapseAll() {
  document.querySelectorAll('.extended-row').forEach(row => row.classList.remove('show'));
  document.querySelectorAll('.expand-toggle').forEach(btn => btn.classList.remove('expanded'));
}

function saveExtendedTracking(idx) {
  const data = {
    job: jobName,
    cargo_idx: idx,
    border_arrived_on: document.getElementById('border1_arrived_' + idx)?.value || null,
    border_left_on: document.getElementById('border1_left_' + idx)?.value || null,
    border_2_arrived_on: document.getElementById('border2_arrived_' + idx)?.value || null,
    border_2_left_on: document.getElementById('border2_left_' + idx)?.value || null,
    offloading_arrived_on: document.getElementById('offloading_arrived_' + idx)?.value || null
  };
  
  frappe.call({
    method: 'freightmas.www.truck_portal.update_extended_tracking',
    args: data,
    callback: (r) => {
      if (r.message && r.message.success) {
        showToast('Extended tracking saved', 'success');
      }
    },
    error: () => showToast('Failed to save', 'error')
  });
}

// ========================================
// TRUCK MODAL
// ========================================
function loadSuppliers() {
  if (allSuppliers.length > 0) return Promise.resolve();
  
  return new Promise((resolve) => {
    frappe.call({
      method: 'frappe.client.get_list',
      args: {
        doctype: 'Supplier',
        filters: { disabled: 0 },
        fields: ['name', 'supplier_name'],
        limit_page_length: 500,
        order_by: 'supplier_name asc'
      },
      callback: (r) => {
        if (r.message) allSuppliers = r.message;
        resolve();
      }
    });
  });
}

function setupSupplierSearch() {
  const input = document.getElementById('transporterInput');
  const dropdown = document.getElementById('supplierDropdown');
  if (!input || !dropdown) return;
  
  // Pre-load suppliers
  loadSuppliers();
  
  input.addEventListener('focus', async function() {
    await loadSuppliers();
    // Show all if empty or show filtered
    const term = this.value.toLowerCase().trim();
    showSupplierDropdown(term, input, dropdown);
  });
  
  input.addEventListener('input', async function() {
    await loadSuppliers();
    const term = this.value.toLowerCase().trim();
    showSupplierDropdown(term, input, dropdown);
  });
  
  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.remove('show');
    }
  });
}

function showSupplierDropdown(term, input, dropdown) {
  let filtered;
  if (term.length < 1) {
    // Show first 10 if no search term
    filtered = allSuppliers.slice(0, 10);
  } else {
    filtered = allSuppliers.filter(s => 
      (s.supplier_name || '').toLowerCase().includes(term) || 
      (s.name || '').toLowerCase().includes(term)
    ).slice(0, 10);
  }
  
  if (filtered.length > 0) {
    dropdown.innerHTML = filtered.map(s => `
      <div class="supplier-item" data-value="${s.name}">
        <div class="supplier-name">${s.supplier_name || s.name}</div>
        ${s.supplier_name && s.supplier_name !== s.name ? `<div class="supplier-code">${s.name}</div>` : ''}
      </div>
    `).join('');
    
    dropdown.querySelectorAll('.supplier-item').forEach(item => {
      item.addEventListener('click', () => {
        input.value = item.querySelector('.supplier-name').textContent;
        input.dataset.supplierId = item.dataset.value;
        dropdown.classList.remove('show');
      });
    });
    
    dropdown.classList.add('show');
  } else {
    dropdown.classList.remove('show');
  }
}

function openTruckModal(idx) {
  currentCargoIdx = idx;
  loadSuppliers();
  loadTrucks();
  
  // Reset form
  document.getElementById('truckForm').reset();
  document.getElementById('fetchTruckInput').value = '';
  document.getElementById('transporterInput').removeAttribute('data-supplier-id');
  document.getElementById('supplierDropdown').classList.remove('show');
  document.getElementById('truckDropdown').classList.remove('show');
  
  // Load existing data
  const row = document.querySelector(`.cargo-row[data-idx="${idx}"]`);
  if (row) {
    frappe.call({
      method: 'freightmas.www.truck_portal.get_cargo_details',
      args: { job: jobName, cargo_idx: idx },
      callback: (r) => {
        if (r.message) {
          const d = r.message.truck_details;
          document.getElementById('transporterInput').value = d.transporter_name || d.transporter || '';
          if (d.transporter) document.getElementById('transporterInput').dataset.supplierId = d.transporter;
          document.getElementById('truckRegInput').value = d.truck_reg_no || '';
          document.getElementById('trailerRegInput').value = d.trailer_reg_no || '';
          document.getElementById('driverNameInput').value = d.driver_name || '';
          document.getElementById('contact1Input').value = d.driver_contact_no || '';
          document.getElementById('contact2Input').value = d.driver_contact_no_2 || '';
          document.getElementById('passportInput').value = d.driver_passport_no || '';
          document.getElementById('licenceInput').value = d.driver_licence_no || '';
        }
      },
      error: () => {} // Silently fail - form will just be empty
    });
  }
  
  document.getElementById('truckModal').classList.add('show');
  setTimeout(() => document.getElementById('fetchTruckInput').focus(), 100);
}

function closeTruckModal() {
  document.getElementById('truckModal').classList.remove('show');
  document.getElementById('supplierDropdown').classList.remove('show');
  document.getElementById('truckDropdown').classList.remove('show');
  document.getElementById('fetchTruckInput').value = '';
  currentCargoIdx = null;
}

// ========================================
// FETCH FROM TRUCK
// ========================================
let allTrucks = [];

function loadTrucks() {
  if (allTrucks.length > 0) return Promise.resolve();
  
  return new Promise((resolve) => {
    frappe.call({
      method: 'frappe.client.get_list',
      args: {
        doctype: 'Truck',
        fields: ['name', 'horse', 'assigned_trailer', 'assigned_driver', 'assigned_driver_name', 'cell_number', 'cell_number2', 'passport_number', 'license_number'],
        limit_page_length: 500
      },
      callback: (r) => {
        if (r.message) allTrucks = r.message;
        resolve();
      },
      error: () => resolve()
    });
  });
}

function setupTruckSearch() {
  const input = document.getElementById('fetchTruckInput');
  const dropdown = document.getElementById('truckDropdown');
  if (!input || !dropdown) return;
  
  input.addEventListener('focus', () => loadTrucks());
  
  input.addEventListener('input', function() {
    const term = this.value.toLowerCase().trim();
    if (term.length < 2) {
      dropdown.classList.remove('show');
      return;
    }
    
    const filtered = allTrucks.filter(t => 
      (t.horse || '').toLowerCase().includes(term) ||
      (t.name || '').toLowerCase().includes(term) ||
      (t.assigned_driver_name || '').toLowerCase().includes(term)
    ).slice(0, 8);
    
    if (filtered.length > 0) {
      dropdown.innerHTML = filtered.map(t => `
        <div class="supplier-item" data-truck='${JSON.stringify(t)}'>
          <div class="supplier-name">${t.horse || t.name}</div>
          <div class="supplier-code">${t.assigned_driver_name || 'No driver'} | ${t.assigned_trailer || 'No trailer'}</div>
        </div>
      `).join('');
      
      dropdown.querySelectorAll('.supplier-item').forEach(item => {
        item.addEventListener('click', () => {
          const truck = JSON.parse(item.dataset.truck);
          fillTruckDetails(truck);
          dropdown.classList.remove('show');
          input.value = truck.horse || truck.name;
        });
      });
      
      dropdown.classList.add('show');
    } else {
      dropdown.classList.remove('show');
    }
  });
  
  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.remove('show');
    }
  });
}

function fillTruckDetails(truck) {
  document.getElementById('truckRegInput').value = truck.horse || '';
  document.getElementById('trailerRegInput').value = truck.assigned_trailer || '';
  document.getElementById('driverNameInput').value = truck.assigned_driver_name || '';
  document.getElementById('contact1Input').value = truck.cell_number || '';
  document.getElementById('contact2Input').value = truck.cell_number2 || '';
  document.getElementById('passportInput').value = truck.passport_number || '';
  document.getElementById('licenceInput').value = truck.license_number || '';
  
  // If driver details missing but driver is linked, fetch from Driver doctype
  if (truck.assigned_driver && (!truck.cell_number || !truck.passport_number || !truck.license_number)) {
    frappe.call({
      method: 'frappe.client.get_value',
      args: {
        doctype: 'Driver',
        filters: { name: truck.assigned_driver },
        fieldname: ['cell_number', 'cell_number2', 'passport_number', 'license_number']
      },
      callback: (r) => {
        if (r.message) {
          const d = r.message;
          if (!document.getElementById('contact1Input').value && d.cell_number)
            document.getElementById('contact1Input').value = d.cell_number;
          if (!document.getElementById('contact2Input').value && d.cell_number2)
            document.getElementById('contact2Input').value = d.cell_number2;
          if (!document.getElementById('passportInput').value && d.passport_number)
            document.getElementById('passportInput').value = d.passport_number;
          if (!document.getElementById('licenceInput').value && d.license_number)
            document.getElementById('licenceInput').value = d.license_number;
        }
      }
    });
  }
  showToast('Truck details loaded', 'success');
}

function fetchFromTruck() {
  const input = document.getElementById('fetchTruckInput');
  const searchTerm = input.value.trim().toUpperCase();
  
  if (!searchTerm) {
    showToast('Enter truck registration', 'error');
    return;
  }
  
  // Find matching truck
  const truck = allTrucks.find(t => 
    (t.horse || '').toUpperCase() === searchTerm ||
    (t.name || '').toUpperCase() === searchTerm
  );
  
  if (truck) {
    fillTruckDetails(truck);
  } else {
    // Try to fetch from server
    frappe.call({
      method: 'frappe.client.get_value',
      args: {
        doctype: 'Truck',
        filters: { horse: ['like', `%${searchTerm}%`] },
        fieldname: ['name', 'horse', 'assigned_trailer', 'assigned_driver', 'assigned_driver_name', 'cell_number', 'cell_number2', 'passport_number', 'license_number']
      },
      callback: (r) => {
        if (r.message && r.message.name) {
          fillTruckDetails(r.message);
        } else {
          showToast('Truck not found', 'error');
        }
      },
      error: () => showToast('Truck not found', 'error')
    });
  }
}

function saveTruckDetails(event) {
  event.preventDefault();
  if (currentCargoIdx === null) return;
  
  const transporterInput = document.getElementById('transporterInput');
  const supplierId = transporterInput.dataset.supplierId || transporterInput.value;
  const truckReg = document.getElementById('truckRegInput').value.toUpperCase().trim();
  const driverName = document.getElementById('driverNameInput').value.trim();
  const contact1 = document.getElementById('contact1Input').value.trim();
  
  // Validation
  if (!supplierId || !truckReg || !driverName || !contact1) {
    showToast('Please fill required fields', 'error');
    return;
  }
  
  const btn = document.getElementById('saveTruckBtn');
  const spinner = document.getElementById('truckSpinner');
  btn.disabled = true;
  spinner.style.display = 'inline-block';
  
  frappe.call({
    method: 'freightmas.www.truck_portal.update_truck_details',
    args: {
      job: jobName,
      cargo_idx: currentCargoIdx,
      transporter: supplierId,
      truck_reg_no: truckReg,
      trailer_reg_no: document.getElementById('trailerRegInput').value.toUpperCase(),
      driver_name: driverName,
      driver_contact_no: contact1,
      driver_contact_no_2: document.getElementById('contact2Input').value,
      driver_passport_no: document.getElementById('passportInput').value.toUpperCase(),
      driver_licence_no: document.getElementById('licenceInput').value.toUpperCase()
    },
    callback: (r) => {
      if (r.message && r.message.success) {
        showToast('Truck details saved', 'success');
        closeTruckModal();
        setTimeout(() => location.reload(), 800);
      }
    },
    error: () => showToast('Failed to save', 'error'),
    always: () => {
      btn.disabled = false;
      spinner.style.display = 'none';
    }
  });
}

// ========================================
// TOAST
// ========================================
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 6000);
}

// ========================================
// KEYBOARD SHORTCUTS
// ========================================
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeTruckModal();
    closeMilestoneModal();
  }
});

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.classList.remove('show');
    }
  });
});
</script>
{% endblock %}
