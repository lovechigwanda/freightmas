{%- set no_default_print_heading = 1 -%}
{% set active_jobs = frappe.get_all('Forwarding Job', 
    filters={
        'customer': doc.name,
        'status': ['in', ['Draft', 'In Progress', 'Delivered']],
        'docstatus': ['<', 2]
    },
    fields=[
        'name', 'date_created', 'customer_reference', 'direction', 'shipment_mode', 'shipment_type',
        'status', 'port_of_loading', 'port_of_discharge', 'destination', 'cargo_description',
        'bl_number', 'etd', 'eta', 'ata', 'vessel_flight_no', 'modified', 'current_comment',
        'last_updated_on', 'bl_confirmed_date', 'discharge_date', 'completed_on', 'cargo_count'
    ],
    order_by='date_created desc'
) %}

<div class="print-format">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; font-size: 10px; color: #000; line-height: 1.3; background: #fff; }
    .print-format { width: 100%; max-width: 100%; padding: 15px; }
    
    @page { size: A4; margin: 20mm; }
    
    .header-title { 
      text-align: center; 
      font-size: 18px; 
      font-weight: bold; 
      margin-bottom: 8px; 
      text-transform: uppercase; 
      color: #000;
      letter-spacing: 1px;
    }
    
    .customer-name {
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      color: #000;
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    
    .header-subtitle {
      text-align: center;
      font-size: 11px;
      color: #000;
      margin-bottom: 25px;
      line-height: 1.4;
    }
    
    .section-title { 
      font-weight: bold; 
      font-size: 12px; 
      margin: 15px 0 8px 0; 
      text-transform: uppercase; 
      color: #000;
      background: #f0f0f0;
      border: 1px solid #000;
      padding: 6px 8px;
      letter-spacing: 0.5px;
    }
    
    .job-title {
      font-weight: bold; 
      font-size: 12px; 
      margin: 15px 0 10px 0; 
      text-transform: uppercase; 
      color: #000;
      background: #fff;
      border-bottom: 1px solid #000;
      padding: 4px 0;
      letter-spacing: 0.3px;
      text-align: left;
    }
    
    .summary-table, .details-table, .tracking-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      border: 1px solid #000;
      background: #fff;
      font-size: 11px;
    }    .summary-table th, .details-table th, .tracking-table th { 
      background-color: #f0f0f0; 
      color: #000;
      padding: 5px 4px; 
      border: 1px solid #000;
      text-align: center; 
      font-weight: bold; 
      font-size: 11px;
      text-transform: uppercase;
      line-height: 1.2;
    }
    
    .summary-table td, .details-table td, .tracking-table td { 
      padding: 4px; 
      border: 1px solid #000; 
      text-align: left; 
      font-size: 11px;
      line-height: 1.2;
      vertical-align: top;
    }
    
    .job-info {
      font-size: 11px;
      margin-bottom: 8px;
      line-height: 1.3;
      color: #000;
    }
    
    .job-details-compact {
      margin-bottom: 10px;
      font-size: 11px;
      border: 1px solid #000;
      padding: 5px 8px;
      background: #fff;
      line-height: 1.4;
    }
    
    .job-details-label {
      font-weight: bold;
      color: #000;
    }
    
    .job-details-value {
      color: #000;
      margin-right: 20px;
    }
    
    .footer { 
      margin-top: 20px; 
      text-align: center; 
      font-size: 9px; 
      color: #000; 
      border-top: 1px solid #000; 
      padding-top: 8px;
    }
    
    @media print { 
      body { padding: 0; margin: 0; }
      .print-format { padding: 10px; }
      .page-break { page-break-before: always; }
      .summary-table, .details-table, .tracking-table { page-break-inside: avoid; }
    }
  </style>

  <!-- Main Header -->
  <div class="header-title">Consolidated Tracking Report</div>
  <div class="customer-name">{{ doc.customer_name }}</div>
  <div class="header-subtitle">
    Report Generated: {{ frappe.utils.format_datetime(frappe.utils.now(), "dd-MMM-yyyy HH:mm") }} Total Active Jobs: {{ active_jobs|length }}
  </div>

  {% if active_jobs %}
    <!-- Job Summary Section -->
    <div class="section-title">Job Summary</div>
    <table class="summary-table">
      <thead>
        <tr>
          <th>Job ID</th>
          <th>Reference</th>
          <th>ETA</th>
          <th>Tracking Updates</th>
        </tr>
      </thead>
      <tbody>
        {% for job in active_jobs %}
          {% set job_doc = frappe.get_doc('Forwarding Job', job.name) %}
          <tr>
            <td>{{ job.name }}</td>
            <td>{{ job.customer_reference or '—' }}</td>
            <td>{{ frappe.utils.formatdate(job.eta, 'dd-MMM-yy') if job.eta else '—' }}</td>
            <td>{{ job_doc.current_comment or '—' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Detailed Job Tracking Section -->
    <div class="section-title" style="margin-top: 25px;">Detailed Job Tracking</div>

    <!-- Individual Job Details -->
    {% for job in active_jobs %}
      {% set job_doc = frappe.get_doc('Forwarding Job', job.name) %}
      {% set containers = job_doc.cargo_parcel_details or [] %}
      
      <!-- Job Header -->
      <div class="job-title">Job {{ loop.index }}: {{ job.name }} - {{ job.customer_reference or job.name }}{% if job_doc.consignee %} - {{ job_doc.consignee }}{% endif %}</div>
      
      <!-- Job Details Compact Layout -->
      <div class="job-details-compact">
        <span class="job-details-label">Mode:</span> <span class="job-details-value">{{ (job.shipment_mode or "Sea") ~ " " ~ (job.direction or "Import") }}</span>
        <span class="job-details-label">Job Date:</span> <span class="job-details-value">{{ frappe.utils.formatdate(job.date_created, "dd-MMM-yy") if job.date_created else "—" }}</span>
        <span class="job-details-label">Cargo:</span> <span class="job-details-value">{{ job.cargo_count or "—" }}</span>
        <span class="job-details-label">Origin:</span> <span class="job-details-value">{{ job.port_of_loading or "—" }}</span>
        <span class="job-details-label">Destination:</span> <span class="job-details-value">{{ job.destination or job.port_of_discharge or "—" }}</span>
        <span class="job-details-label">Cargo Desc:</span> <span class="job-details-value">{{ job.cargo_description or "—" }}</span>
        <span class="job-details-label">ETA:</span> <span class="job-details-value">{{ frappe.utils.formatdate(job_doc.eta, "dd-MMM-yy") if job_doc.eta else "—" }}</span>
        <span class="job-details-label">ATA:</span> <span class="job-details-value">{{ frappe.utils.formatdate(job_doc.ata, "dd-MMM-yy") if job_doc.ata else "—" }}</span>
        <span class="job-details-label">Discharge:</span> <span class="job-details-value">{{ frappe.utils.formatdate(job_doc.discharge_date, "dd-MMM-yy") if job_doc.discharge_date else "—" }}</span>
      </div>
      
      <!-- Tracking Comment -->
      {% if job_doc.current_comment %}
      <div class="job-info">
        <strong>Tracking Comment:</strong> {{ job_doc.current_comment }} &nbsp;&nbsp; <strong>Updated:</strong> {{ frappe.utils.formatdate(job_doc.last_updated_on, "dd-MMM-yy") if job_doc.last_updated_on else "—" }}
      </div>
      {% endif %}
      
      <!-- Container/Cargo Tracking Table -->
      <table class="tracking-table">
        <thead>
          <tr>
            <th>Cargo/Container</th>
            <th>Loaded</th>
            <th>Offloaded</th>
            <th>Returned</th>
            <th>Completed</th>
            <th>Tracking Comment</th>
          </tr>
        </thead>
        <tbody>
          {% for row in containers %}
          <tr>
            <td>
              {%- if row.cargo_type == "Containerised" or row.cargo_type == "General Cargo" -%}
                {{ row.container_number or "—" }}
              {%- else -%}
                {{ row.cargo_item_description or "—" }}
              {%- endif -%}
            </td>
            <td>{{ frappe.utils.formatdate(row.loaded_on_date, "dd-MMM-yy") if row.loaded_on_date else "—" }}</td>
            <td>{{ frappe.utils.formatdate(row.offloaded_on_date, "dd-MMM-yy") if row.offloaded_on_date else "—" }}</td>
            <td>{{ frappe.utils.formatdate(row.returned_on_date, "dd-MMM-yy") if row.returned_on_date else "—" }}</td>
            <td>{{ frappe.utils.formatdate(row.completed_on_date, "dd-MMM-yy") if row.completed_on_date else "—" }}</td>
            <td>{{ row.tracking_comment or "—" }}</td>
          </tr>
          {% endfor %}
          {% if not containers %}
          <tr>
            <td colspan="6" style="text-align: center; font-style: italic; color: #666;">
              No cargo details available
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
      
      {% if not loop.last %}
      <div style="margin: 20px 0; border-bottom: 1px solid #ccc;"></div>
      {% endif %}
    {% endfor %}
  {% else %}
    <div style="text-align: center; padding: 50px 20px; color: #666;">
      <h3>No Active Jobs Found</h3>
      <p>This customer currently has no active forwarding jobs.</p>
    </div>
  {% endif %}

  <!-- Footer -->
  <div class="footer">
    <p>FreightMas</p>
    <p>Please contact your account manager if you need clarity on anything</p>
    <p>Generated on {{ frappe.utils.formatdate(frappe.utils.now(), "dd-MMM-yyyy") }}</p>
  </div>
</div>