{%- set no_default_print_heading = 1 -%}
{% set active_jobs = frappe.get_all('Forwarding Job', 
    filters={
        'customer': doc.name,
        'status': ['in', ['Draft', 'In Progress', 'Delivered']],
        'docstatus': ['<', 2]
    },
    fields=[
        'name', 'date_created', 'customer_reference', 'direction', 'shipment_mode', 'shipment_type',
        'status', 'port_of_loading', 'port_of_discharge', 'destination', 'cargo_description',
        'bl_number', 'etd', 'eta', 'ata', 'vessel_flight_no', 'modified', 'current_comment',
        'last_updated_on', 'bl_confirmed_date', 'discharge_date', 'completed_on', 'cargo_count'
    ],
    order_by='date_created desc'
) %}

<div class="print-format">
  <style>
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      font-family: Arial, sans-serif; 
      font-size: 14px; 
    }
    
    .print-format { 
      width: 100%; 
      max-width: 100%; 
      padding: 3mm; 
      font-family: Arial, sans-serif; 
      font-size: 14px; 
    }
    
    @page { size: A4; margin: 15mm; }
    
    .page-border {
      position: fixed;
      top: 0mm;
      left: 0mm;
      right: 0mm;
      bottom: 0mm;
      border: 1px solid #000;
      z-index: 0;
      pointer-events: none;
    }
    
    .heading-label { 
      font-size: 18px; 
      font-weight: 700; 
      text-align: center; 
      color: #000; 
      margin-bottom: 2px; 
      letter-spacing: 1px; 
      text-transform: uppercase; 
    }
    
    .company-name {
      text-align: center;
      font-size: 16px;
      font-weight: 700;
      color: #000;
      margin-bottom: 4px;
    }
    
    .customer-name {
      text-align: center;
      font-size: 16px;
      font-weight: 700;
      color: #000;
      margin-bottom: 4px;
    }
    
    .header-subtitle {
      text-align: center;
      font-size: 12px;
      color: #000;
      margin-bottom: 12px;
      line-height: 1.3;
    }
    
    .section { margin-bottom: 8px; }
    
    .section-title { 
      font-size: 16px; 
      font-weight: 600; 
      border-bottom: 1px solid #000; 
      color: #000; 
      margin-bottom: 10px; 
      padding-bottom: 2px; 
    }
    
    .job-title {
      font-size: 16px; 
      font-weight: 600; 
      border-bottom: 1px solid #000; 
      color: #000; 
      margin: 15px 0 6px 0; 
      padding-bottom: 2px; 
    }
    
    .info-table, .summary-table, .tracking-table { 
      width: 100%; 
      border-collapse: collapse; 
    }
    
    .info-table td { 
      padding: 2px 0; 
      vertical-align: top; 
      font-size: 12px; 
    }
    
    .summary-table th { 
      background: #fff; 
      color: #000; 
      border: 1px solid #ccc; 
      padding: 4px 8px; 
      font-weight: 700; 
      font-size: 12px; 
      text-align: left;
      white-space: nowrap;
    }
    
    .summary-table td { 
      padding: 4px 8px; 
      border: 1px solid #ccc; 
      vertical-align: top; 
      line-height: 1.15; 
      font-size: 12px; 
    }
    
    .summary-table td.nowrap {
      white-space: nowrap;
    }
    
    .tracking-table th { 
      background: #fff; 
      color: #000; 
      border: 1px solid #ccc; 
      padding: 4px 8px; 
      font-weight: 700; 
      font-size: 12px; 
      text-align: left;
    }
    
    .tracking-table td { 
      padding: 4px 8px; 
      border: 1px solid #ccc; 
      vertical-align: top; 
      line-height: 1.15; 
      font-size: 12px; 
    }
    
    .tracking-table td.nowrap {
      white-space: nowrap;
    }
    
    .job-details-row {
      margin-bottom: 6px;
      font-size: 12px;
      line-height: 1.4;
    }
    
    .job-details-row strong {
      font-weight: 600;
    }
    
    .job-summary-text {
      font-size: 12px;
      line-height: 1.5;
      margin-bottom: 6px;
      color: #333;
    }
    
    .job-summary-text .sep {
      color: #999;
      margin: 0 6px;
    }
    
    .tracking-comment {
      font-size: 12px;
      margin-bottom: 8px;
      line-height: 1.4;
      color: #000;
      padding: 8px 10px;
      border: 1px solid #ccc;
    }
    
    .tracking-comment strong {
      font-weight: 600;
    }
    
    .tracking-comment .sep {
      color: #999;
      margin: 0 6px;
    }
    
    .rt { text-align: right; }
    .cn { text-align: center; }
    
    .footer-note { 
      font-size: 11px; 
      color: #000; 
      text-align: center; 
      margin-top: 15px; 
      padding-top: 8px;
      border-top: 1px solid #000;
    }
    
    .job-separator {
      margin: 10px 0;
      border-bottom: 1px dashed #ccc;
    }
    
    @media print { 
      body { padding: 0; margin: 0; }
      .print-format { padding: 3mm; }
      .summary-table, .tracking-table { page-break-inside: avoid; }
    }
  </style>

  <div class="page-border"></div>

  <!-- Main Header -->
  {% set company_name = frappe.db.get_single_value("Global Defaults", "default_company") or "" %}
  <div class="company-name">{{ company_name }}</div>
  <div class="heading-label">Consolidated Tracking Report</div>
  <div class="customer-name">For: {{ doc.customer_name }}</div>
  <div class="header-subtitle">
    Report Generated: {{ frappe.utils.format_datetime(frappe.utils.now(), "dd-MMM-yyyy HH:mm") }} | Total Active Jobs: {{ active_jobs|length }}
  </div>

  {% if active_jobs %}
    <!-- Job Summary Section -->
    <div class="section">
      <div class="section-title">JOB SUMMARY</div>
      <table class="summary-table">
        <thead>
          <tr>
            <th style="width: 3ch;">#</th>
            <th style="width: 15ch;">Job ID</th>
            <th style="width: 17ch;">Reference</th>
            <th style="width: 10ch;">ETA</th>
            <th>Tracking Updates</th>
          </tr>
        </thead>
        <tbody>
          {% for job in active_jobs %}
            {% set job_doc = frappe.get_doc('Forwarding Job', job.name) %}
            <tr>
              <td class="nowrap">{{ loop.index }}</td>
              <td class="nowrap">{{ job.name }}</td>
              <td class="nowrap">{{ job.customer_reference or '—' }}</td>
              <td class="nowrap">{{ frappe.utils.formatdate(job.eta, 'dd-MMM-yy') if job.eta else '—' }}</td>
              <td>{{ job_doc.current_comment or '—' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Section Separator -->
    <div style="margin: 15px 0; border-bottom: 1px dashed #ccc;"></div>

    <!-- Detailed Job Tracking Section -->
    <div class="section">
      <div class="section-title" style="margin-bottom: 16px;">DETAILED JOB TRACKING</div>

      {% for job in active_jobs %}
        {% set job_doc = frappe.get_doc('Forwarding Job', job.name) %}
        {% set containers = job_doc.cargo_parcel_details or [] %}
        
        <!-- Job Header -->
        <div class="job-title">JOB {{ loop.index }}: {{ job.name }} - {{ job.customer_reference or job.name }}{% if job_doc.consignee %} - {{ job_doc.consignee }}{% endif %}</div>
        
        <!-- Job Details Flowing Sentence -->
        <div class="job-summary-text">
          {{ (job.shipment_mode or "Sea") ~ " " ~ (job.direction or "Import") }} job dated {{ frappe.utils.formatdate(job.date_created, "dd-MMM-yy") if job.date_created else "—" }}<span class="sep">•</span>{{ job.cargo_count or "—" }} from {{ job.port_of_loading or "—" }} to {{ job.destination or job.port_of_discharge or "—" }}<span class="sep">•</span>ETA: {{ frappe.utils.formatdate(job_doc.eta, "dd-MMM-yy") if job_doc.eta else "—" }}{% if job_doc.ata %}<span class="sep">•</span>ATA: {{ frappe.utils.formatdate(job_doc.ata, "dd-MMM-yy") }}{% endif %}{% if job_doc.discharge_date %}<span class="sep">•</span>Discharged: {{ frappe.utils.formatdate(job_doc.discharge_date, "dd-MMM-yy") }}{% endif %}{% if job.cargo_description %}<span class="sep">•</span>{{ job.cargo_description }}{% endif %}
        </div>
        
        <!-- Tracking Comment -->
        {% if job_doc.current_comment %}
        <div class="tracking-comment">
          <strong>Tracking Comment:</strong> {{ job_doc.current_comment }}<span class="sep">•</span><strong>Updated:</strong> {{ frappe.utils.formatdate(job_doc.last_updated_on, "dd-MMM-yy") if job_doc.last_updated_on else "—" }}
        </div>
        {% endif %}
        
        <!-- Container/Cargo Tracking Table -->
        <table class="tracking-table">
          <thead>
            <tr>
              <th style="width: 18%;">Cargo/Container</th>
              <th style="width: 10%;">Loaded</th>
              <th style="width: 10%;">Offloaded</th>
              <th style="width: 10%;">Returned</th>
              <th style="width: 10%;">Completed</th>
              <th style="width: 42%;">Comment</th>
            </tr>
          </thead>
          <tbody>
            {% for row in containers %}
            <tr>
              <td class="nowrap">
                {%- if row.cargo_type == "Containerised" or row.cargo_type == "General Cargo" -%}
                  {{ row.container_number or "—" }}
                {%- else -%}
                  {{ row.cargo_item_description or "—" }}
                {%- endif -%}
              </td>
              <td class="nowrap">{{ frappe.utils.formatdate(row.loaded_on_date, "dd-MMM-yy") if row.loaded_on_date else "—" }}</td>
              <td class="nowrap">{{ frappe.utils.formatdate(row.offloaded_on_date, "dd-MMM-yy") if row.offloaded_on_date else "—" }}</td>
              <td class="nowrap">{{ frappe.utils.formatdate(row.returned_on_date, "dd-MMM-yy") if row.returned_on_date else "—" }}</td>
              <td class="nowrap">{{ frappe.utils.formatdate(row.completed_on_date, "dd-MMM-yy") if row.completed_on_date else "—" }}</td>
              <td>{{ row.tracking_comment or "—" }}</td>
            </tr>
            {% endfor %}
            {% if not containers %}
            <tr>
              <td colspan="6" style="text-align: center; font-style: italic; color: #666;">
                No cargo details available
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
        
        {% if not loop.last %}
        <div class="job-separator"></div>
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <div style="text-align: center; padding: 40px 20px; color: #666;">
      <p style="font-size: 14px; font-weight: 600;">No Active Jobs Found</p>
      <p>This customer currently has no active forwarding jobs.</p>
    </div>
  {% endif %}

  <!-- Footer -->
  <div class="footer-note">
    Please contact your account manager if you need clarity on anything | Generated on {{ frappe.utils.formatdate(frappe.utils.now(), "dd-MMM-yyyy") }}
  </div>
</div>
