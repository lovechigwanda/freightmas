{%- set no_default_print_heading = 1 -%}
{% set active_jobs = frappe.get_all('Forwarding Job', 
    filters={
        'customer': doc.name,
        'status': ['in', ['Draft', 'In Progress', 'Delivered']],
        'docstatus': ['<', 2]
    },
    fields=[
        'name', 'date_created', 'customer_reference', 'direction', 'shipment_mode', 'shipment_type',
        'status', 'port_of_loading', 'port_of_discharge', 'destination', 'cargo_description',
        'bl_number', 'etd', 'eta', 'ata', 'vessel_flight_no', 'modified', 'current_comment',
        'last_updated_on', 'bl_confirmed_date', 'discharge_date', 'completed_on', 'cargo_count'
    ],
    order_by='date_created desc'
) %}

<div class="print-format">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; font-size: 10px; color: #000; line-height: 1.2; background: #fff; }
    .print-format { width: 100%; max-width: 100%; padding: 10px; }
    
    @page { size: A4; margin: 15mm; }
    
    .header-title { 
      text-align: center; 
      font-size: 16px; 
      font-weight: 700; 
      margin-bottom: 4px; 
      text-transform: uppercase; 
      color: #000;
      letter-spacing: 0.3px;
    }
    
    .customer-name {
      text-align: center;
      font-size: 14px;
      font-weight: 700;
      color: #000;
      margin-bottom: 4px;
      margin-top: 0px;
      text-transform: uppercase;
      letter-spacing: 0.2px;
    }
    
    .header-subtitle {
      text-align: center;
      font-size: 12px;
      color: #000;
      margin-bottom: 20px;
      line-height: 1.3;
    }
    
    .section-title { 
      font-weight: 700; 
      font-size: 16px; 
      margin: 12px 0 6px 0; 
      text-transform: uppercase; 
      color: #000;
      background: #fff;
      border-bottom: 2px solid #000;
      padding: 5px 8px;
      letter-spacing: 0.2px;
    }
    
    .job-title {
      font-weight: 700; 
      font-size: 16px; 
      margin: 20px 0 8px 0; 
      text-transform: uppercase; 
      color: #0066cc;
      background: #fff;
      border-bottom: 2px solid #0066cc;
      padding: 5px 8px;
      letter-spacing: 0.2px;
      text-align: left;
    }
    
    .sub-section-title { 
      font-weight: 700; 
      font-size: 16px; 
      margin: 20px 0 8px 0; 
      text-transform: uppercase; 
      color: #0066cc;
      background: #fff;
      border-bottom: 2px solid #0066cc;
      padding: 5px 8px;
      letter-spacing: 0.2px;
      text-align: left;
    }
    
    .section-divider {
      border-top: 3px solid #ccc;
      margin: 40px 0 30px 0;
      page-break-inside: avoid;
    }
    
    .job-separator {
      border-top: 3px solid #2E86AB;
      margin: 25px 0 15px 0;
      padding-top: 15px;
    }
    
    .job-title {
      font-size: 14px;
      font-weight: bold;
      color: #2E86AB;
      margin-bottom: 8px;
      text-align: center;
    }
    
    .summary-table, .charge-table, .party-table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-bottom: 12px;
      border: 1px solid #000;
      background: #fff;
      font-size: 10px;
    }
    
    .summary-table th, .charge-table th, .party-table th { 
      background-color: #fff; 
      color: #000;
      padding: 4px 6px; 
      border: 1px solid #000;
      text-align: left; 
      font-weight: 700; 
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1px;
      white-space: normal;
      word-wrap: break-word;
      line-height: 1.1;
    }
    
    .summary-table th:first-child, .charge-table th:first-child, .party-table th:first-child {
      text-align: left;
    }
    
    .summary-table td, .charge-table td, .party-table td { 
      padding: 3px 6px; 
      border: 1px solid #000; 
      text-align: left; 
      font-size: 10px;
      line-height: 1.1;
      vertical-align: top;
    }
    
    .summary-table td:first-child,
    .charge-table td:first-child, 
    .party-table td:first-child { 
      text-align: left; 
      font-weight: 500;
    }
    
    .party-table td:last-child {
      text-align: left;
      word-wrap: break-word;
      white-space: normal;
      max-width: 200px;
      font-size: 10px;
      line-height: 1.2;
    }
    
    .party-table th:last-child {
      text-align: left;
    }
    
    .border-milestone {
      font-size: 9px;
      padding: 2px 4px;
    }
    
    .footer { 
      margin-top: 20px; 
      text-align: center; 
      font-size: 10px; 
      color: #000; 
      border-top: 1px solid #000; 
      padding-top: 8px;
    }
    
    @media print { 
      body { padding: 5px; margin: 0; }
      .print-format { padding: 5px; }
      .page-break { page-break-before: always; }
      .job-separator { page-break-before: always; }
      .summary-table, .charge-table, .party-table { page-break-inside: avoid; }
    }
  </style>

  <!-- Main Header -->
  <div class="header-title">Consolidated Tracking Report</div>
  <div class="customer-name">{{ doc.customer_name }}</div>
  <div class="header-subtitle">
    Report Generated: {{ frappe.utils.format_datetime(frappe.utils.now(), "dd-MMM-yyyy HH:mm") }}<br>
    Total Active Jobs: {{ active_jobs|length }}
  </div>

  {% if active_jobs %}
    <!-- Summary Section -->
    <div class="section-title">ðŸ“Š Jobs Summary</div>
    <table class="summary-table">
      <thead>
        <tr>
          <th style="width:20%; text-align:left;">Job ID</th>
          <th style="width:20%; text-align:left;">Reference</th>
          <th style="width:15%; text-align:left;">Cargo Count</th>
          <th style="width:15%; text-align:left;">ETA</th>
          <th style="width:15%; text-align:left;">ATA</th>
          <th style="width:15%; text-align:left;">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for job in active_jobs %}
          <tr>
            <td style="text-align:left;">{{ job.name }}</td>
            <td style="text-align:left;">{{ job.customer_reference or 'â€”' }}</td>
            <td style="text-align:left;">{{ job.cargo_count or 'â€”' }}</td>
            <td style="text-align:left;">{{ frappe.utils.formatdate(job.eta, 'dd-MMM-yy') if job.eta else 'â€”' }}</td>
            <td style="text-align:left;">{{ frappe.utils.formatdate(job.ata, 'dd-MMM-yy') if job.ata else 'â€”' }}</td>
            <td style="text-align:left;">{{ job.status }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Detailed Job Tracking Section -->
    <div class="section-title">ðŸ“‹ Detailed Job Tracking</div>

    <!-- Individual Job Details -->
    {% for job in active_jobs %}
      {% set job_doc = frappe.get_doc('Forwarding Job', job.name) %}
      {% set containers = job_doc.cargo_parcel_details or [] %}
      
      <div class="{% if loop.index > 1 %}job-separator{% endif %}">
        <div class="job-title">JOB {{ loop.index }}: {{ job.name }} - {{ job.customer_reference or 'No Reference' }}</div>
        
        <!-- Job Header Info -->
                <!-- Job Header Info -->
                <!-- Job Header Info -->\n        <div style=\"text-align: left; font-size: 11px; margin-bottom: 12px; line-height: 1.3;\">\n          Mode: {{ (job.shipment_mode or \"Sea\") ~ \" \" ~ (job.direction or \"Import\") }} | Date Created: {{ frappe.utils.formatdate(job.date_created, \"dd-MMM-yy\") if job.date_created else \"â€”\" }}<br>\n          Route: {{ job.port_of_loading or \"â€”\" }} â†’ {{ job.destination or job.port_of_discharge or \"â€”\" }} | Cargo Count: {{ job.cargo_count or \"â€”\" }}\n        </div>"
        
        <!-- Key Dates Timeline -->
        <div class="sub-section-title">Key Dates Timeline</div>
        <table class="charge-table">
          <thead>
            <tr>
              <th style="width:20%;">ETA</th>
              <th style="width:20%;">ATA</th>
              <th style="width:20%;">BL CONFIRMED ON</th>
              <th style="width:20%;">DISCHARGED ON</th>
              <th style="width:20%;">COMPLETED ON</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>{{ frappe.utils.formatdate(job_doc.eta, "dd-MMM-yy") if job_doc.eta else "â€”" }}</td>
              <td>{{ frappe.utils.formatdate(job_doc.ata, "dd-MMM-yy") if job_doc.ata else "â€”" }}</td>
              <td>{{ frappe.utils.formatdate(job_doc.bl_confirmed_date, "dd-MMM-yy") if job_doc.bl_confirmed_date else "â€”" }}</td>
              <td>{{ frappe.utils.formatdate(job_doc.discharge_date, "dd-MMM-yy") if job_doc.discharge_date else "â€”" }}</td>
              <td>{{ frappe.utils.formatdate(job_doc.completed_on, "dd-MMM-yy") if job_doc.completed_on else "â€”" }}</td>
            </tr>
          </tbody>
        </table>

<div class="sub-section-title">Job Tracking Status</div>
<div class="tracking-table">
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Status</th>
        <th>Current Milestone</th>
        <th>Last Updated On</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ job.status }}</td>
        <td>{{ current_milestone }}</td>
        <td>{{ last_updated }}</td>
      </tr>
    </tbody>
  </table>
</div>
        
        <!-- Job Tracking Status -->
        <div class="section-title">Job Tracking Status</div>
        <table class="summary-table">
          <thead>
            <tr>
              <th style="width:20%;">STATUS</th>
              <th style="width:50%; text-align:left;">CURRENT MILESTONE</th>
              <th style="width:30%;">LAST UPDATED ON</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="text-align:left; font-weight:bold;">{{ job_doc.status or "â€”" }}</td>
              <td style="text-align:left;">{{ job_doc.current_comment or "â€”" }}</td>
              <td>{{ frappe.utils.formatdate(job_doc.last_updated_on, "dd-MMM-yy") if job_doc.last_updated_on else "â€”" }}</td>
            </tr>
          </tbody>\n        </table>\n        \n        <!-- Cargo Tracking Details -->
        <div class="section-title">Cargo Tracking Details</div>
        <table class="party-table">
          <thead>
            <tr>
              <th style="width:14%;">CARGO/CONTAINER</th>
              <th style="width:10%;">LOADED ON</th>
              {%- set has_border_1 = containers | selectattr("border_tracking") | list | length > 0 -%}
              {%- set has_border_2 = containers | selectattr("border_2_tracking") | list | length > 0 -%}
              {%- set has_offloading_point = containers | selectattr("offloading_point", "equalto", 1) | list | length > 0 -%}
              {% if has_border_1 %}<th class="border-milestone" style="width:8%;">BORDER 1</th>{% endif %}
              {% if has_border_2 %}<th class="border-milestone" style="width:8%;">BORDER 2</th>{% endif %}
              {% if has_offloading_point %}<th class="border-milestone" style="width:8%;">OFFLOADING POINT</th>{% endif %}
              <th style="width:10%;">OFFLOADED ON</th>
              <th style="width:10%;">RETURNED ON</th>
              <th style="width:10%;">COMPLETED ON</th>
              <th style="width:{% if has_border_1 or has_border_2 or has_offloading_point %}26{% else %}44{% endif %}%;">TRACKING COMMENT</th>
            </tr>
          </thead>
          <tbody>
            {% for row in containers %}
            <tr>
              <td style="text-align:left;">
                {%- if row.cargo_type == "Containerised" or row.cargo_type == "General Cargo" -%}
                  {{ row.container_number or "â€”" }}
                {%- else -%}
                  {{ row.cargo_item_description or "â€”" }}
                {%- endif -%}
              </td>
              <td>{{ frappe.utils.formatdate(row.loaded_on_date, "dd-MMM-yy") if row.loaded_on_date else "â€”" }}</td>
              {% if has_border_1 %}
              <td class="border-milestone" style="font-size:10px; line-height:1.2;">
                {%- if row.border_tracking and row.border_name -%}
                  {{ row.border_name }}<br>
                  {%- if row.border_arrived_on -%}
                    In: {{ frappe.utils.formatdate(row.border_arrived_on, "dd-MMM") }}
                  {%- endif -%}
                  {%- if row.border_left_on -%}
                    {%- if row.border_arrived_on -%}<br>{%- endif -%}
                    Out: {{ frappe.utils.formatdate(row.border_left_on, "dd-MMM") }}
                  {%- endif -%}
                {%- else -%}
                  â€”
                {%- endif -%}
              </td>
              {% endif %}
              {% if has_border_2 %}
              <td class="border-milestone" style="font-size:10px; line-height:1.2;">
                {%- if row.border_2_tracking and row.border_2_name -%}
                  {{ row.border_2_name }}<br>
                  {%- if row.border_2_arrived_on -%}
                    In: {{ frappe.utils.formatdate(row.border_2_arrived_on, "dd-MMM") }}
                  {%- endif -%}
                  {%- if row.border_2_left_on -%}
                    {%- if row.border_2_arrived_on -%}<br>{%- endif -%}
                    Out: {{ frappe.utils.formatdate(row.border_2_left_on, "dd-MMM") }}
                  {%- endif -%}
                {%- else -%}
                  â€”
                {%- endif -%}
              </td>
              {% endif %}
              {% if has_offloading_point %}
              <td class="border-milestone" style="font-size:10px; line-height:1.2;">
                {{ frappe.utils.formatdate(row.offloading_arrived_on, "dd-MMM-yy") if row.offloading_arrived_on else "â€”" }}
              </td>
              {% endif %}
              <td>{{ frappe.utils.formatdate(row.offloaded_on_date, "dd-MMM-yy") if row.offloaded_on_date else "â€”" }}</td>
              <td>{{ frappe.utils.formatdate(row.returned_on_date, "dd-MMM-yy") if row.returned_on_date else "â€”" }}</td>
              <td>{{ frappe.utils.formatdate(row.completed_on_date, "dd-MMM-yy") if row.completed_on_date else "â€”" }}</td>
              <td style="text-align:left;">{{ row.tracking_comment or "â€”" }}</td>
            </tr>
            {% endfor %}
            {% if not containers %}
            <tr>
              <td colspan="{{ 7 + (1 if has_border_1 else 0) + (1 if has_border_2 else 0) + (1 if has_offloading_point else 0) }}" style="text-align: center; font-style: italic; color: #666;">
                No cargo details available
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% else %}
    <div style="text-align: center; padding: 50px 20px; color: #666;">
      <h3>No Active Jobs Found</h3>
      <p>This customer currently has no active forwarding jobs.</p>
    </div>
  {% endif %}

  <!-- Footer -->
  <div class="footer">
    <p>FreightMas Logistics - Generated on {{ frappe.utils.formatdate(frappe.utils.now(), "dd-MMM-yy") }}</p>
  </div>
</div>